<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#667eea">
<title>VacuFlow ENI ¬∑ MSP Ecuador</title>
<link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
/* ===================================================
   VARIABLES ‚Äî TaskFlow palette exacta
   =================================================== */
:root {
  --bg-color:          #f0f4f8;
  --text-color:        #2d3748;
  --grid-dot:          #cbd5e0;
  --glass-bg:          rgba(255,255,255,0.72);
  --glass-border:      1px solid rgba(255,255,255,0.7);
  --shadow-soft:       0 8px 32px 0 rgba(31,38,135,0.07);
  --accent-color:      #667eea;
  --accent2:           #764ba2;
  --btn-bg:            #fff;
  --btn-text:          #2d3748;
  --modal-bg:          rgba(255,255,255,0.98);
  --col-header-bg:     rgba(255,255,255,0.85);
  --input-bg:          #fff;
  --empty-text:        #a0aec0;
  --tape-color:        rgba(255,255,255,0.55);
  --surface:           rgba(255,255,255,0.85);
  --border-light:      rgba(203,213,224,0.6);
  --green:             #059669;
  --red:               #dc2626;
  --orange:            #d97706;
  --blue:              #2563eb;
  --purple:            #7c3aed;
}
.dark-mode {
  --bg-color:          #1a202c;
  --text-color:        #e2e8f0;
  --grid-dot:          #4a5568;
  --glass-bg:          rgba(26,32,44,0.65);
  --glass-border:      1px solid rgba(255,255,255,0.09);
  --shadow-soft:       0 8px 32px 0 rgba(0,0,0,0.45);
  --accent-color:      #a3bffa;
  --accent2:           #b794f4;
  --btn-bg:            #2d3748;
  --btn-text:          #e2e8f0;
  --modal-bg:          rgba(26,32,44,0.98);
  --col-header-bg:     rgba(45,55,72,0.85);
  --input-bg:          #2d3748;
  --empty-text:        #5f6c80;
  --tape-color:        rgba(255,255,255,0.12);
  --surface:           rgba(45,55,72,0.8);
  --border-light:      rgba(74,85,104,0.6);
  --green:             #34d399;
  --red:               #f87171;
  --orange:            #fbbf24;
  --blue:              #60a5fa;
  --purple:            #a78bfa;
}

/* ===================================================
   ANIMACIONES
   =================================================== */
@keyframes popIn {
  0%   { transform: scale(0.4) rotate(-5deg); opacity: 0; }
  65%  { transform: scale(1.08) rotate(1deg); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}
@keyframes fadeSlideUp {
  from { opacity: 0; transform: translateY(16px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes headerIn {
  from { opacity: 0; transform: translateY(-18px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes tabIn {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes shake {
  0%,100% { transform: translateX(0); }
  20%     { transform: translateX(-8px); }
  40%     { transform: translateX(8px); }
  60%     { transform: translateX(-5px); }
  80%     { transform: translateX(5px); }
}
@keyframes pulse {
  0%,100% { transform: scale(1); }
  50%     { transform: scale(1.18); }
}
@keyframes badgePulse {
  0%,100% { transform: scale(1); }
  50%     { transform: scale(1.35); }
}

/* ===================================================
   BASE
   =================================================== */
*,*::before,*::after { box-sizing: border-box; margin: 0; padding: 0; }
html { -webkit-text-size-adjust: 100%; }

body {
  font-family: 'Nunito', 'Segoe UI', sans-serif;
  background-color: var(--bg-color);
  background-image: radial-gradient(var(--grid-dot) 1.5px, transparent 1.5px);
  background-size: 25px 25px;
  color: var(--text-color);
  min-height: 100vh;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  transition: background-color 0.4s, color 0.3s;
  -webkit-tap-highlight-color: transparent;
}

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb {
  background: rgba(156,163,175,0.4);
  border-radius: 8px;
  border: 2px solid transparent;
  background-clip: content-box;
}

/* ===================================================
   HEADER
   =================================================== */
header {
  padding: 10px 20px;
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  background: var(--glass-bg);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-bottom: var(--glass-border);
  position: sticky; top: 0; z-index: 500;
  box-shadow: 0 2px 20px rgba(0,0,0,0.05);
  animation: headerIn 0.5s ease forwards;
  transition: background 0.4s;
}
.header-left { display: flex; align-items: center; gap: 8px; }
.logo {
  font-family: 'Indie Flower', cursive;
  font-size: 2rem; font-weight: 700;
  background: linear-gradient(135deg, #667eea, #764ba2);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 2px 4px rgba(102,126,234,0.2));
  cursor: default; letter-spacing: -0.5px;
}
.version-tag {
  font-size: 0.75rem; font-weight: 800;
  color: var(--accent-color);
  -webkit-text-fill-color: var(--accent-color);
  background: none;
}
.header-center { text-align: center; }
.header-right {
  display: flex; align-items: center; justify-content: flex-end; gap: 8px;
}
.ctrl-btn {
  padding: 6px 14px; border-radius: 12px;
  border: 1px solid var(--grid-dot);
  background: var(--btn-bg); color: var(--btn-text);
  cursor: pointer; font-family: 'Nunito', sans-serif;
  font-size: 0.82rem; font-weight: 700; outline: none;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  transition: transform 0.15s, box-shadow 0.2s, background 0.3s;
  white-space: nowrap;
}
.ctrl-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 14px rgba(0,0,0,0.1); }
.ctrl-btn:active { transform: scale(0.94); }
.date-badge {
  font-size: 0.78rem; font-weight: 800;
  background: linear-gradient(135deg,#667eea22,#764ba222);
  border: 1px solid var(--accent-color);
  color: var(--accent-color);
  padding: 5px 12px; border-radius: 20px;
  white-space: nowrap;
}

/* ===================================================
   TABS NAV
   =================================================== */
.tabs-nav {
  display: flex; justify-content: center; gap: 6px;
  padding: 12px 16px 0;
  flex-wrap: wrap;
}
.tab-btn {
  padding: 8px 18px; border-radius: 30px;
  border: 2px solid var(--border-light);
  background: var(--glass-bg); color: var(--text-color);
  cursor: pointer; font-family: 'Nunito', sans-serif;
  font-size: 0.82rem; font-weight: 800; outline: none;
  backdrop-filter: blur(10px);
  transition: all 0.25s; white-space: nowrap;
  display: flex; align-items: center; gap: 6px;
}
.tab-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 14px rgba(102,126,234,0.15); }
.tab-btn.active {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white; border-color: transparent;
  box-shadow: 0 6px 20px rgba(118,75,162,0.35);
  transform: translateY(-1px);
}
.tab-badge {
  background: rgba(255,255,255,0.3);
  color: white; font-size: 0.68rem; font-weight: 900;
  padding: 1px 7px; border-radius: 10px;
  min-width: 20px; text-align: center;
}
.tab-btn:not(.active) .tab-badge {
  background: var(--accent-color);
  color: white;
}

/* ===================================================
   CONTENT √ÅREA
   =================================================== */
.content-area {
  flex: 1; padding: 14px 16px 30px;
  max-width: 1100px; margin: 0 auto; width: 100%;
}
.tab-panel { display: none; animation: tabIn 0.35s ease; }
.tab-panel.active { display: block; }

/* ===================================================
   GLASS CARD
   =================================================== */
.glass-card {
  background: var(--glass-bg);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: var(--glass-border);
  border-radius: 20px;
  box-shadow: var(--shadow-soft);
  transition: background 0.4s, box-shadow 0.3s;
}
.card-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 16px; flex-wrap: wrap; gap: 8px;
}
.card-title {
  font-family: 'Indie Flower', cursive;
  font-size: 1.5rem; color: var(--accent-color);
  display: flex; align-items: center; gap: 8px;
}
.card-subtitle {
  font-size: 0.75rem; font-weight: 700;
  color: var(--empty-text); text-transform: uppercase; letter-spacing: 1px;
}

/* ===================================================
   FORM FIELDS
   =================================================== */
.field-group { margin-bottom: 14px; }
.field-label {
  display: block; font-size: 0.72rem; font-weight: 800;
  color: var(--empty-text); text-transform: uppercase;
  letter-spacing: 1.2px; margin-bottom: 6px; margin-left: 4px;
}
.field-input {
  width: 100%; padding: 11px 16px;
  border-radius: 14px; border: 2px solid transparent;
  background: linear-gradient(var(--input-bg),var(--input-bg)) padding-box,
              linear-gradient(135deg,var(--grid-dot),var(--grid-dot)) border-box;
  color: var(--text-color);
  font-family: 'Nunito', sans-serif;
  font-size: 0.95rem; font-weight: 700; outline: none;
  transition: all 0.25s;
  -webkit-appearance: none; appearance: none;
}
.field-input:focus {
  background: linear-gradient(var(--input-bg),var(--input-bg)) padding-box,
              linear-gradient(135deg,#667eea,#764ba2) border-box;
  box-shadow: 0 4px 18px rgba(102,126,234,0.18);
}
.field-input::placeholder { color: var(--empty-text); font-weight: 600; }
select.field-input {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23a0aec0' stroke-width='3'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 14px center;
  padding-right: 36px; cursor: pointer;
  background-color: var(--input-bg);
}
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

/* ===================================================
   VACCINE SELECTOR
   =================================================== */
.vac-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 10px; margin: 12px 0; }
.vac-card {
  padding: 12px 14px; border-radius: 14px;
  border: 2px solid var(--border-light);
  background: var(--surface);
  cursor: pointer; transition: all 0.22s;
  display: flex; align-items: center; gap: 10px;
  user-select: none;
}
.vac-card:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(102,126,234,0.12); }
.vac-card:active { transform: scale(0.96); }
.vac-card.selected {
  border-color: #059669;
  background: rgba(5,150,105,0.08);
  box-shadow: 0 4px 14px rgba(5,150,105,0.15);
}
.vac-emoji { font-size: 1.6rem; flex-shrink: 0; }
.vac-info { flex: 1; min-width: 0; }
.vac-name { font-weight: 800; font-size: 0.92rem; line-height: 1.2; }
.vac-meta { font-size: 0.65rem; font-weight: 700; color: var(--empty-text); text-transform: uppercase; letter-spacing: 0.8px; margin-top: 2px; }
.vac-check {
  width: 22px; height: 22px; border-radius: 50%;
  border: 2.5px solid var(--grid-dot);
  display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem; flex-shrink: 0; transition: all 0.2s;
  color: transparent;
}
.vac-card.selected .vac-check {
  background: #059669; border-color: #059669; color: white;
}

/* ===================================================
   BUTTONS
   =================================================== */
.btn {
  padding: 11px 26px; border-radius: 30px; border: none;
  font-family: 'Nunito', sans-serif; font-size: 0.9rem; font-weight: 800;
  cursor: pointer; transition: all 0.2s; outline: none;
  display: inline-flex; align-items: center; gap: 8px;
}
.btn:active { transform: scale(0.95); }
.btn-primary {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white; box-shadow: 0 6px 20px rgba(118,75,162,0.35);
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 26px rgba(118,75,162,0.42); }
.btn-green {
  background: linear-gradient(135deg, #059669, #047857);
  color: white; box-shadow: 0 6px 18px rgba(5,150,105,0.3);
}
.btn-green:hover { transform: translateY(-2px); }
.btn-orange {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white; box-shadow: 0 6px 18px rgba(245,158,11,0.3);
}
.btn-red {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white; box-shadow: 0 4px 14px rgba(239,68,68,0.3);
}
.btn-ghost {
  background: var(--surface); color: var(--text-color);
  border: 1.5px solid var(--border-light);
}
.btn-ghost:hover { transform: translateY(-2px); box-shadow: 0 5px 14px rgba(0,0,0,0.08); }
.btn-sm { padding: 6px 14px; font-size: 0.78rem; border-radius: 20px; }
.btn-full { width: 100%; justify-content: center; }

/* ===================================================
   ALERT / BADGE
   =================================================== */
.age-badge {
  background: linear-gradient(135deg,#667eea18,#764ba218);
  border: 1px solid var(--accent-color);
  border-radius: 12px; padding: 9px 14px;
  font-size: 0.82rem; font-weight: 700; color: var(--accent-color);
  display: none; margin-top: 8px;
}
.stock-badge {
  display: inline-block; padding: 3px 10px; border-radius: 20px;
  font-size: 0.7rem; font-weight: 800; text-transform: uppercase;
}
.stock-ok   { background: rgba(5,150,105,0.12); color: var(--green); }
.stock-warn { background: rgba(245,158,11,0.12); color: var(--orange); }
.stock-out  { background: rgba(220,38,38,0.12);  color: var(--red); }

/* ===================================================
   PATIENT RECORD CARD ‚Äî Estilo sticky note
   =================================================== */
.patient-card {
  padding: 14px 14px 10px; border-radius: 6px;
  box-shadow: 2px 5px 14px rgba(0,0,0,0.09);
  font-family: 'Nunito', sans-serif; font-size: 0.9rem;
  position: relative; transition: transform 0.2s, box-shadow 0.2s;
  margin-bottom: 10px;
}
.patient-card:hover {
  transform: translateY(-3px) rotate(0deg);
  box-shadow: 5px 10px 24px rgba(0,0,0,0.13);
}
.patient-card::before {
  content: ''; position: absolute; top: -10px; left: 50%;
  transform: translateX(-50%) rotate(-1deg);
  width: 70px; height: 22px;
  background: var(--tape-color);
  box-shadow: 0 1px 4px rgba(0,0,0,0.07);
  z-index: 1; pointer-events: none;
  backdrop-filter: blur(3px);
}
.pc-name { font-weight: 900; font-size: 1rem; color: #1a202c; margin-bottom: 3px; }
.dark-mode .pc-name { color: #f7fafc; }
.pc-meta { font-size: 0.7rem; font-weight: 700; color: #718096; margin-bottom: 8px; }
.pc-tags { display: flex; flex-wrap: wrap; gap: 5px; }
.pc-tag {
  font-size: 0.65rem; font-weight: 800; padding: 3px 9px;
  border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px;
}
.pc-actions { display: flex; justify-content: flex-end; gap: 6px; margin-top: 8px; }
.icon-btn {
  background: rgba(255,255,255,0.65); border: none;
  width: 30px; height: 30px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.07);
  transition: transform 0.2s, box-shadow 0.2s;
}
.icon-btn:hover { transform: scale(1.2); box-shadow: 0 4px 10px rgba(0,0,0,0.12); }
.icon-btn:active { transform: scale(0.9); }

/* Colors for sticky notes */
.bg-yellow { background: #fef3c7; }
.bg-blue   { background: #bfdbfe; }
.bg-green  { background: #bbf7d0; }
.bg-pink   { background: #fbcfe8; }
.bg-purple { background: #e9d5ff; }
.bg-orange { background: #ffedd5; }
.bg-cyan   { background: #ccfbf1; }

/* ===================================================
   KARDEX CARDS
   =================================================== */
.kdx-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px,1fr)); gap: 10px; }
.kdx-card {
  background: var(--surface); border: var(--glass-border);
  border-radius: 16px; padding: 14px 12px;
  text-align: center; cursor: pointer; transition: all 0.22s;
  box-shadow: var(--shadow-soft);
  position: relative; overflow: hidden;
}
.kdx-card::after {
  content: ''; position: absolute; inset: 0;
  border-radius: 16px; opacity: 0; transition: opacity 0.2s;
  background: linear-gradient(135deg,rgba(102,126,234,0.08),rgba(118,75,162,0.08));
}
.kdx-card:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.1); }
.kdx-card:hover::after { opacity: 1; }
.kdx-card:active { transform: scale(0.96); }
.kdx-card.danger { border-color: rgba(220,38,38,0.4); background: rgba(220,38,38,0.06); }
.kdx-card.warn   { border-color: rgba(245,158,11,0.4); background: rgba(245,158,11,0.06); }
.kdx-name { font-size: 0.68rem; font-weight: 800; color: var(--empty-text); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; line-height: 1.2; }
.kdx-saldo { font-family: 'Indie Flower', cursive; font-size: 2.4rem; font-weight: 700; line-height: 1; }
.kdx-card.danger .kdx-saldo { color: var(--red); }
.kdx-card.warn   .kdx-saldo { color: var(--orange); }
.kdx-mini { font-size: 0.6rem; font-weight: 700; color: var(--empty-text); margin-top: 6px; display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; }
.kdx-mini span { background: var(--bg-color); border-radius: 6px; padding: 2px 5px; }

/* ===================================================
   MOVEMENT LOG TABLE
   =================================================== */
.mov-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
.mov-table th {
  text-align: left; padding: 8px 12px;
  font-size: 0.65rem; font-weight: 800; text-transform: uppercase;
  letter-spacing: 1px; color: var(--empty-text);
  border-bottom: 2px solid var(--border-light);
}
.mov-table td { padding: 9px 12px; border-bottom: 1px solid var(--border-light); font-weight: 600; }
.mov-table tr:last-child td { border-bottom: none; }
.mov-table tr:hover td { background: rgba(102,126,234,0.04); }
.mov-type { padding: 3px 10px; border-radius: 20px; font-size: 0.68rem; font-weight: 800; text-transform: uppercase; }
.mov-ingreso   { background: rgba(5,150,105,0.12);  color: var(--green); }
.mov-perdida   { background: rgba(220,38,38,0.12);  color: var(--red); }
.mov-devolucion{ background: rgba(37,99,235,0.12);  color: var(--blue); }
.mov-egreso    { background: rgba(124,58,237,0.12); color: var(--purple); }

/* ===================================================
   STATS CARDS
   =================================================== */
.stats-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px,1fr)); gap: 10px; margin-bottom: 16px; }
.stat-card {
  background: var(--surface); border: var(--glass-border);
  border-radius: 16px; padding: 14px 16px;
  box-shadow: var(--shadow-soft); text-align: center;
}
.stat-num { font-family: 'Indie Flower', cursive; font-size: 2.2rem; line-height: 1; }
.stat-label { font-size: 0.65rem; font-weight: 800; color: var(--empty-text); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }

/* ===================================================
   FILTROS DE FECHA
   =================================================== */
.filter-bar { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; margin-bottom: 14px; }
.filter-btn {
  padding: 5px 14px; border-radius: 20px;
  border: 1.5px solid var(--border-light);
  background: var(--surface); color: var(--text-color);
  cursor: pointer; font-family: 'Nunito', sans-serif;
  font-size: 0.78rem; font-weight: 800; transition: all 0.2s;
}
.filter-btn:hover { transform: translateY(-1px); }
.filter-btn.active {
  background: linear-gradient(135deg,#667eea,#764ba2);
  color: white; border-color: transparent;
  box-shadow: 0 4px 14px rgba(118,75,162,0.3);
}

/* ===================================================
   EXPORT CARD
   =================================================== */
.export-card {
  background: var(--surface); border: var(--glass-border);
  border-radius: 16px; padding: 16px 18px;
  display: flex; align-items: center; gap: 14px;
  cursor: pointer; transition: all 0.22s; box-shadow: var(--shadow-soft);
  margin-bottom: 10px;
}
.export-card:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(0,0,0,0.1); }
.export-card:active { transform: scale(0.97); }
.export-icon { font-size: 2rem; flex-shrink: 0; }
.export-info { flex: 1; }
.export-title { font-weight: 800; font-size: 0.95rem; }
.export-sub { font-size: 0.72rem; font-weight: 600; color: var(--empty-text); margin-top: 2px; }

/* ===================================================
   MODAL
   =================================================== */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.5); backdrop-filter: blur(6px);
  display: flex; justify-content: center; align-items: flex-end;
  opacity: 0; pointer-events: none; transition: opacity 0.3s;
  z-index: 1000; padding: 0;
}
.modal-overlay.show { opacity: 1; pointer-events: all; }
.modal-content {
  background: var(--modal-bg);
  border-radius: 26px 26px 0 0; padding: 24px 22px;
  width: 100%; max-width: 520px; margin: 0 auto;
  max-height: 90vh; overflow-y: auto;
  box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
  transform: translateY(60px); opacity: 0;
  transition: transform 0.36s cubic-bezier(0.34,1.56,0.64,1), opacity 0.3s;
}
.modal-overlay.show .modal-content { transform: translateY(0); opacity: 1; }
.modal-handle { width: 44px; height: 5px; background: var(--grid-dot); border-radius: 4px; margin: 0 auto 20px; }
.modal-title {
  font-family: 'Indie Flower', cursive;
  font-size: 1.8rem; color: var(--accent-color); text-align: center; margin-bottom: 18px;
}

/* ===================================================
   SECTION DIVIDER
   =================================================== */
.section-divider {
  display: flex; align-items: center; gap: 10px;
  font-size: 0.68rem; font-weight: 800; text-transform: uppercase;
  letter-spacing: 1.5px; color: var(--empty-text);
  margin: 18px 0 12px;
}
.section-divider::before, .section-divider::after {
  content: ''; flex: 1; height: 1px; background: var(--border-light);
}

/* ===================================================
   TOAST
   =================================================== */
.toast {
  position: fixed; bottom: 28px; left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: rgba(30,41,59,0.96); color: white;
  padding: 12px 26px; border-radius: 30px;
  opacity: 0; transition: all 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
  pointer-events: none; z-index: 3000;
  font-weight: 700; font-size: 0.88rem;
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);
  backdrop-filter: blur(10px); max-width: 90%;
  text-align: center; white-space: nowrap;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ===================================================
   ALERT STOCK
   =================================================== */
.stock-alert-bar {
  background: rgba(220,38,38,0.1); border: 1px solid rgba(220,38,38,0.3);
  border-radius: 12px; padding: 10px 16px; margin-bottom: 14px;
  font-size: 0.82rem; font-weight: 700; color: var(--red);
  display: none; animation: fadeSlideUp 0.3s ease;
}

/* ===================================================
   CLOSE MONTH SECTION
   =================================================== */
.close-month-card {
  background: linear-gradient(135deg,rgba(102,126,234,0.08),rgba(118,75,162,0.08));
  border: var(--glass-border); border-radius: 18px; padding: 18px;
  box-shadow: var(--shadow-soft); margin-top: 16px;
}

/* ===================================================
   ESQUEMA PENDIENTE
   =================================================== */
.pending-card {
  background: var(--surface); border: var(--glass-border);
  border-radius: 14px; padding: 12px 16px; margin-bottom: 8px;
  display: flex; align-items: center; justify-content: space-between; gap: 10px;
  box-shadow: var(--shadow-soft);
}
.pending-name { font-weight: 800; font-size: 0.92rem; }
.pending-info { font-size: 0.7rem; font-weight: 600; color: var(--empty-text); margin-top: 2px; }
.pending-chips { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
.pending-chip {
  font-size: 0.6rem; font-weight: 800; padding: 2px 8px;
  border-radius: 10px; background: rgba(245,158,11,0.15); color: var(--orange);
}

/* ===================================================
   EMPTY STATE
   =================================================== */
.empty-state {
  text-align: center; padding: 40px 20px;
  font-family: 'Indie Flower', cursive;
  font-size: 1.1rem; color: var(--empty-text);
  animation: fadeSlideUp 0.4s ease;
}
.empty-state .empty-icon { font-size: 3rem; margin-bottom: 10px; }

/* ===================================================
   RESPONSIVE ‚Äî MOBILE FIRST
   =================================================== */
@media (max-width: 640px) {
  header { grid-template-columns: 1fr 1fr; gap: 8px; padding: 8px 12px; }
  .header-center { display: none; }
  .logo { font-size: 1.6rem; }
  .tabs-nav { gap: 4px; padding: 10px 12px 0; }
  .tab-btn { padding: 7px 12px; font-size: 0.75rem; }
  .content-area { padding: 12px 12px 24px; }
  .vac-grid { grid-template-columns: 1fr; }
  .stats-row { grid-template-columns: 1fr 1fr; }
  .kdx-grid  { grid-template-columns: repeat(3,1fr); }
  .grid-2, .grid-3 { grid-template-columns: 1fr; }
  .modal-content { padding: 18px 16px; }
  .ctrl-btn { padding: 5px 10px; font-size: 0.75rem; }
}
@media (min-width: 641px) and (max-width: 900px) {
  header { grid-template-columns: 1fr auto 1fr; }
  .kdx-grid { grid-template-columns: repeat(4,1fr); }
}
@media (min-width: 901px) {
  .tab-panel-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start;
  }
  .tab-panel-grid-3 {
    display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; align-items: start;
  }
  .kdx-grid { grid-template-columns: repeat(5,1fr); }
}

/* ===================================================
   UTILS
   =================================================== */
.hidden { display: none !important; }
.p-4  { padding: 18px; }
.p-5  { padding: 22px; }
.mb-2 { margin-bottom: 8px; }
.mb-3 { margin-bottom: 12px; }
.mb-4 { margin-bottom: 16px; }
.mt-2 { margin-top: 8px; }
.mt-3 { margin-top: 12px; }
.flex { display: flex; }
.flex-wrap { flex-wrap: wrap; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-2 { gap: 8px; }
.gap-3 { gap: 12px; }
.w-full { width: 100%; }
.text-center { text-align: center; }
.font-hand { font-family: 'Indie Flower', cursive; }
.text-accent { color: var(--accent-color); }
.text-sm { font-size: 0.82rem; }
.text-xs { font-size: 0.7rem; }
.font-bold { font-weight: 800; }
.opacity-60 { opacity: 0.6; }
.shake { animation: shake 0.4s ease; }
</style>
</head>

<body>

<!-- ===================================================
     HEADER
     =================================================== -->
<header>
  <div class="header-left">
    <div class="logo">üíâ VacuFlow <span class="version-tag">ENI</span></div>
  </div>
  <div class="header-center">
    <div id="stock-alert-header" class="stock-alert-bar" style="margin:0;padding:6px 14px;font-size:0.75rem;">
      ‚ö†Ô∏è Stock cr√≠tico ‚Äî revisa el Kardex
    </div>
  </div>
  <div class="header-right">
    <span class="date-badge" id="header-date">Hoy</span>
    <button class="ctrl-btn" onclick="toggleTheme()" id="theme-btn">üåô</button>
  </div>
</header>

<!-- ===================================================
     TABS
     =================================================== -->
<div class="tabs-nav" id="tabs-nav">
  <button class="tab-btn active" onclick="switchTab('vacunar',this)">
    üíâ Vacunar
  </button>
  <button class="tab-btn" onclick="switchTab('diario',this)">
    üìã Parte Diario <span class="tab-badge" id="badge-diario">0</span>
  </button>
  <button class="tab-btn" onclick="switchTab('kardex',this)">
    üì¶ Kardex
  </button>
  <button class="tab-btn" onclick="switchTab('pendientes',this)">
    ‚è≥ Pendientes
  </button>
  <button class="tab-btn" onclick="switchTab('reportes',this)">
    üìä Reportes
  </button>
</div>

<!-- ===================================================
     CONTENT
     =================================================== -->
<div class="content-area">

  <!-- =================== TAB: VACUNAR =================== -->
  <div class="tab-panel active" id="tab-vacunar">
    <div class="tab-panel-grid">

      <!-- Columna izquierda: Formulario -->
      <div>
        <div class="glass-card p-5 mb-4">
          <div class="card-header">
            <div class="card-title">‚ú® Registrar Vacunaci√≥n</div>
            <div class="date-badge" id="vac-date-display"></div>
          </div>

          <div class="field-group">
            <label class="field-label">üìÖ Fecha de aplicaci√≥n</label>
            <input type="date" id="p-fecha" class="field-input" onchange="validateFecha()">
            <div id="fecha-warn" style="font-size:0.72rem;font-weight:700;color:var(--orange);margin-top:4px;display:none;">
              ‚ö†Ô∏è No se permiten fechas futuras
            </div>
          </div>

          <div class="field-group">
            <label class="field-label">üë∂ Nombre completo del paciente</label>
            <input type="text" id="p-name" class="field-input" placeholder="Ej. Juan Carlos P√©rez L√≥pez" autocomplete="off">
          </div>

          <div class="grid-2 mb-3">
            <div class="field-group" style="margin:0">
              <label class="field-label">üéÇ Fecha de nacimiento</label>
              <input type="date" id="p-dob" class="field-input" onchange="calcEsquema()">
            </div>
            <div class="field-group" style="margin:0">
              <label class="field-label">üìå Esquema</label>
              <select id="p-esquema" class="field-input" onchange="renderVaccines()">
                <option value="0">Reci√©n Nacido</option>
                <option value="2">2 Meses</option>
                <option value="4">4 Meses</option>
                <option value="6">6 Meses</option>
                <option value="12">12 Meses</option>
                <option value="15">15 Meses</option>
                <option value="18">18 Meses</option>
              </select>
            </div>
          </div>

          <div id="age-badge" class="age-badge"></div>
        </div>

        <!-- Vacunas selector -->
        <div class="glass-card p-5">
          <div class="card-header">
            <div class="card-title">üíä Dosis del Esquema</div>
            <span id="sel-count" style="font-size:0.78rem;font-weight:800;color:var(--accent-color)">0 selec.</span>
          </div>
          <div class="vac-grid" id="vaccine-selector"></div>

          <div class="mt-3">
            <button class="btn btn-primary btn-full" onclick="saveRecord()">
              üíæ Registrar y Descontar Stock
            </button>
          </div>
        </div>
      </div>

      <!-- Columna derecha: Resumen r√°pido del d√≠a -->
      <div>
        <div class="glass-card p-5">
          <div class="card-header">
            <div class="card-title">üìä Resumen Hoy</div>
            <div id="quick-date" style="font-size:0.75rem;font-weight:700;color:var(--empty-text)"></div>
          </div>
          <div class="stats-row" id="quick-stats"></div>
          <div class="section-divider">√∫ltimas vacunaciones</div>
          <div id="quick-list" style="max-height:320px;overflow-y:auto;"></div>
        </div>
      </div>

    </div>
  </div><!-- /tab-vacunar -->

  <!-- =================== TAB: PARTE DIARIO =================== -->
  <div class="tab-panel" id="tab-diario">

    <div class="glass-card p-5 mb-4">
      <div class="card-header">
        <div class="card-title">üìã Parte Diario</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <input type="text" id="search-input" class="field-input" style="width:180px;padding:7px 14px;font-size:0.82rem;"
            placeholder="üîç Buscar paciente..." oninput="renderDiario()">
        </div>
      </div>

      <div class="filter-bar">
        <button class="filter-btn active" onclick="setFilter('hoy',this)">üìÖ Hoy</button>
        <button class="filter-btn" onclick="setFilter('semana',this)">üìÜ Esta semana</button>
        <button class="filter-btn" onclick="setFilter('mes',this)">üóìÔ∏è Este mes</button>
        <button class="filter-btn" onclick="setFilter('todo',this)">üìÇ Todo</button>
        <input type="date" id="filter-date" class="field-input" style="width:150px;padding:6px 12px;font-size:0.8rem;" onchange="setFilter('fecha',null)" title="Elegir fecha espec√≠fica">
      </div>

      <!-- Stats del filtro -->
      <div class="stats-row" id="diario-stats"></div>

      <!-- Lista de pacientes -->
      <div id="patient-list"></div>
      <div id="empty-diario" class="empty-state hidden">
        <div class="empty-icon">üóíÔ∏è</div>
        <div>Sin registros para este per√≠odo</div>
      </div>
    </div>

  </div><!-- /tab-diario -->

  <!-- =================== TAB: KARDEX =================== -->
  <div class="tab-panel" id="tab-kardex">

    <!-- Alert stock cr√≠tico -->
    <div id="stock-alert-kardex" class="stock-alert-bar"></div>

    <div class="tab-panel-grid">

      <!-- Inventario visual -->
      <div>
        <div class="glass-card p-5 mb-4">
          <div class="card-header">
            <div class="card-title">üß™ Biol√≥gicos</div>
            <button class="btn btn-primary btn-sm" onclick="openMovModal('bio')">+ Registrar movimiento</button>
          </div>
          <div class="kdx-grid" id="inv-biologicos"></div>
        </div>

        <div class="glass-card p-5">
          <div class="card-header">
            <div class="card-title">üíâ Jeringas</div>
            <button class="btn btn-primary btn-sm" onclick="openMovModal('jer')">+ Registrar movimiento</button>
          </div>
          <div class="kdx-grid" id="inv-jeringas"></div>
          <p style="font-size:0.68rem;color:var(--empty-text);text-align:center;margin-top:10px;font-weight:700;">
            Toca una tarjeta para ver el detalle y registrar movimientos
          </p>
        </div>
      </div>

      <!-- Historial de movimientos -->
      <div>
        <div class="glass-card p-5">
          <div class="card-header">
            <div class="card-title">üìú Historial de Movimientos</div>
          </div>
          <div class="filter-bar mb-3">
            <button class="filter-btn active" onclick="setMovFilter('hoy',this)">Hoy</button>
            <button class="filter-btn" onclick="setMovFilter('semana',this)">Semana</button>
            <button class="filter-btn" onclick="setMovFilter('mes',this)">Mes</button>
            <button class="filter-btn" onclick="setMovFilter('todo',this)">Todo</button>
          </div>
          <div style="overflow-x:auto;">
            <table class="mov-table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Insumo</th>
                  <th>Tipo</th>
                  <th>Cant.</th>
                  <th>Causa</th>
                </tr>
              </thead>
              <tbody id="mov-tbody"></tbody>
            </table>
          </div>
          <div id="empty-movs" class="empty-state hidden">
            <div class="empty-icon">üì¶</div>
            <div>Sin movimientos en este per√≠odo</div>
          </div>
        </div>

        <!-- Cierre de mes -->
        <div class="close-month-card mt-3">
          <div style="font-family:'Indie Flower',cursive;font-size:1.3rem;color:var(--accent-color);margin-bottom:8px;">üîí Cierre de Mes</div>
          <p style="font-size:0.82rem;font-weight:600;color:var(--text-color);opacity:0.8;margin-bottom:12px;">
            Congela los n√∫meros actuales, genera el reporte final y prepara el Kardex para el nuevo mes. El historial anterior se conserva.
          </p>
          <button class="btn btn-orange btn-full" onclick="closeMonth()">
            üîí Cerrar mes y reiniciar Kardex
          </button>
        </div>
      </div>

    </div>
  </div><!-- /tab-kardex -->

  <!-- =================== TAB: PENDIENTES =================== -->
  <div class="tab-panel" id="tab-pendientes">
    <div class="glass-card p-5">
      <div class="card-header">
        <div class="card-title">‚è≥ Esquemas Pendientes</div>
        <div class="card-subtitle">Ni√±os que deben regresar</div>
      </div>
      <div id="pendientes-list"></div>
      <div id="empty-pendientes" class="empty-state hidden">
        <div class="empty-icon">‚úÖ</div>
        <div>¬°Todos los esquemas est√°n al d√≠a!</div>
      </div>
    </div>
  </div>

  <!-- =================== TAB: REPORTES =================== -->
  <div class="tab-panel" id="tab-reportes">
    <div class="tab-panel-grid">

      <div>
        <div class="glass-card p-5 mb-4">
          <div class="card-header">
            <div class="card-title">üìä Resumen del Mes</div>
          </div>
          <div class="stats-row" id="report-stats"></div>
        </div>

        <div class="glass-card p-5">
          <div class="card-title mb-3">üì§ Exportar a Excel</div>
          <p style="font-size:0.8rem;font-weight:600;color:var(--empty-text);margin-bottom:14px;">
            Todos los archivos se generan listos para copiar en tu matriz MSP.
          </p>

          <div class="export-card" onclick="exportPatients()">
            <div class="export-icon">üë∂</div>
            <div class="export-info">
              <div class="export-title">Pacientes Vacunados</div>
              <div class="export-sub">Registro mensual con fechas, esquemas y dosis ¬∑ .xlsx</div>
            </div>
            <span style="font-size:1.2rem;">‚Üí</span>
          </div>

          <div class="export-card" onclick="exportKardex()">
            <div class="export-icon">üß™</div>
            <div class="export-info">
              <div class="export-title">Kardex de Biol√≥gicos</div>
              <div class="export-sub">Ingresos, egresos, p√©rdidas y saldos ¬∑ .xlsx</div>
            </div>
            <span style="font-size:1.2rem;">‚Üí</span>
          </div>

          <div class="export-card" onclick="exportJeringas()">
            <div class="export-icon">üíâ</div>
            <div class="export-info">
              <div class="export-title">Control de Jeringas</div>
              <div class="export-sub">Movimiento mensual de jeringas ¬∑ .xlsx</div>
            </div>
            <span style="font-size:1.2rem;">‚Üí</span>
          </div>

          <div class="export-card" onclick="exportMovimientos()">
            <div class="export-icon">üìú</div>
            <div class="export-info">
              <div class="export-title">Historial de Movimientos</div>
              <div class="export-sub">Todos los ingresos, p√©rdidas y devoluciones con fecha ¬∑ .xlsx</div>
            </div>
            <span style="font-size:1.2rem;">‚Üí</span>
          </div>

          <div class="export-card" onclick="exportCompleto()" style="border:2px solid var(--accent-color);">
            <div class="export-icon">üóÇÔ∏è</div>
            <div class="export-info">
              <div class="export-title" style="color:var(--accent-color);">Reporte Completo MSP</div>
              <div class="export-sub">4 hojas en un solo archivo ‚Äî formato MSP ¬∑ .xlsx</div>
            </div>
            <span style="font-size:1.2rem;color:var(--accent-color);">‚Üí</span>
          </div>
        </div>
      </div>

      <div>
        <div class="glass-card p-5">
          <div class="card-title mb-3">üóÑÔ∏è Gesti√≥n de Datos</div>
          <p style="font-size:0.8rem;font-weight:600;color:var(--empty-text);margin-bottom:16px;">
            Todos tus datos se guardan localmente en este dispositivo. Funcionan sin internet y sin servidor. Usa "Exportar" para hacer copias de seguridad.
          </p>
          <div style="background:rgba(102,126,234,0.08);border-radius:14px;padding:14px;margin-bottom:14px;">
            <div style="font-size:0.75rem;font-weight:800;color:var(--accent-color);margin-bottom:6px;">‚ÑπÔ∏è INFORMACI√ìN DE ALMACENAMIENTO</div>
            <div id="storage-info" style="font-size:0.8rem;font-weight:600;opacity:0.8;"></div>
          </div>
          <button class="btn btn-red btn-full" onclick="clearAllData()" style="margin-top:8px;">
            üóëÔ∏è Limpiar todos los datos
          </button>
        </div>
      </div>

    </div>
  </div><!-- /tab-reportes -->

</div><!-- /content-area -->

<!-- ===================================================
     MODAL: MOVIMIENTO DE INVENTARIO
     =================================================== -->
<div class="modal-overlay" id="modal-mov">
  <div class="modal-content">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-mov-title">Registrar Movimiento</div>

    <div class="field-group">
      <label class="field-label">üìÖ Fecha del movimiento</label>
      <input type="date" id="mov-fecha" class="field-input" onchange="validateMovFecha()">
      <div id="mov-fecha-warn" style="font-size:0.72rem;font-weight:700;color:var(--orange);margin-top:4px;display:none;">‚ö†Ô∏è No se permiten fechas futuras</div>
    </div>

    <div class="field-group">
      <label class="field-label">üß™ Insumo</label>
      <select id="mov-item" class="field-input"></select>
    </div>

    <div class="field-group">
      <label class="field-label">üìå Tipo de movimiento</label>
      <select id="mov-tipo" class="field-input" onchange="toggleCausa()">
        <option value="ingreso">üì• Ingreso ‚Äî Recibido del Distrito</option>
        <option value="perdida">‚ö†Ô∏è P√©rdida / Descarte</option>
        <option value="devolucion">üì§ Devoluci√≥n al Distrito</option>
      </select>
    </div>

    <div class="field-group">
      <label class="field-label">üî¢ Cantidad</label>
      <input type="number" id="mov-cantidad" class="field-input" placeholder="0" min="1">
    </div>

    <div class="field-group" id="causa-group">
      <label class="field-label">üìù Causa (obligatorio para p√©rdidas)</label>
      <select id="mov-causa" class="field-input">
        <option value="">Seleccionar causa...</option>
        <option value="Frasco abierto no usado">Frasco abierto no usado</option>
        <option value="Vencimiento">Vencimiento</option>
        <option value="Rotura / accidente">Rotura / accidente</option>
        <option value="Fallo cadena de fr√≠o">Fallo cadena de fr√≠o</option>
        <option value="Otra causa">Otra causa</option>
      </select>
    </div>

    <div class="field-group">
      <label class="field-label">üìÑ Observaciones (opcional)</label>
      <input type="text" id="mov-obs" class="field-input" placeholder="Ej. Lote recibido de bodega Distrito 08">
    </div>

    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-ghost btn-full" onclick="closeModal('modal-mov')">Cancelar</button>
      <button class="btn btn-primary btn-full" onclick="saveMovimiento()">üíæ Guardar Movimiento</button>
    </div>
  </div>
</div>

<!-- Modal detalle item Kardex -->
<div class="modal-overlay" id="modal-kdx-detail">
  <div class="modal-content">
    <div class="modal-handle"></div>
    <div class="modal-title" id="kdx-detail-title">Detalle</div>
    <div id="kdx-detail-body"></div>
    <div style="display:flex;gap:10px;margin-top:16px;">
      <button class="btn btn-ghost btn-full" onclick="closeModal('modal-kdx-detail')">Cerrar</button>
      <button class="btn btn-primary btn-full" onclick="closeModal('modal-kdx-detail');openMovModal(currentKdxType)">+ Movimiento</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- ===================================================
     JAVASCRIPT
     =================================================== -->
<script>
/* ===================================================
   BASE DE DATOS MSP
   =================================================== */
const MSP_DB = {
  "0":  [
    { id:'bcg',   name:'BCG',            desc:'ID ¬∑ Intrad√©rmica',   syr:'27G', emoji:'üîµ', color:'bg-blue'   },
    { id:'hb',    name:'Hepatitis B',    desc:'IM ¬∑ Pedi√°trica',    syr:'23G', emoji:'üü°', color:'bg-yellow'  }
  ],
  "2":  [
    { id:'penta', name:'Pentavalente 1', desc:'IM ¬∑ Intramuscular',  syr:'23G', emoji:'üü£', color:'bg-purple'  },
    { id:'fipv',  name:'fIPV (Polio) 1', desc:'IM ¬∑ Intramuscular', syr:'23G', emoji:'üîµ', color:'bg-blue'    },
    { id:'rota',  name:'Rotavirus 1',    desc:'VO ¬∑ Oral',           syr:'oral',emoji:'üü¢', color:'bg-green'  },
    { id:'neumo', name:'Neumococo 1',    desc:'IM ¬∑ Intramuscular',  syr:'23G', emoji:'üî¥', color:'bg-pink'   }
  ],
  "4":  [
    { id:'penta', name:'Pentavalente 2', desc:'IM ¬∑ Intramuscular',  syr:'23G', emoji:'üü£', color:'bg-purple'  },
    { id:'opv',   name:'bOPV (Polio) 2',desc:'VO ¬∑ Oral',           syr:'oral',emoji:'üîµ', color:'bg-cyan'   },
    { id:'rota',  name:'Rotavirus 2',    desc:'VO ¬∑ Oral',           syr:'oral',emoji:'üü¢', color:'bg-green'  },
    { id:'neumo', name:'Neumococo 2',    desc:'IM ¬∑ Intramuscular',  syr:'23G', emoji:'üî¥', color:'bg-pink'   }
  ],
  "6":  [
    { id:'penta', name:'Pentavalente 3', desc:'IM ¬∑ Intramuscular',  syr:'23G', emoji:'üü£', color:'bg-purple'  },
    { id:'opv',   name:'bOPV (Polio) 3',desc:'VO ¬∑ Oral',           syr:'oral',emoji:'üîµ', color:'bg-cyan'   },
    { id:'flu',   name:'Influenza 1',    desc:'IM ¬∑ Intramuscular',  syr:'23G', emoji:'üü†', color:'bg-orange' }
  ],
  "12": [
    { id:'srp',   name:'SRP 1',          desc:'SC ¬∑ Subcut√°nea',     syr:'25G', emoji:'üü°', color:'bg-yellow' },
    { id:'fa',    name:'Fiebre Amarilla',desc:'SC ¬∑ Subcut√°nea',     syr:'25G', emoji:'üü°', color:'bg-yellow' },
    { id:'neumo', name:'Neumo Refuerzo', desc:'IM ¬∑ Intramuscular',  syr:'23G', emoji:'üî¥', color:'bg-pink'   }
  ],
  "15": [
    { id:'vari',  name:'Varicela',       desc:'SC ¬∑ Subcut√°nea',     syr:'25G', emoji:'üü¢', color:'bg-green'  }
  ],
  "18": [
    { id:'dpt',   name:'DPT Refuerzo 1',desc:'IM ¬∑ Intramuscular',  syr:'23G', emoji:'üü£', color:'bg-purple'  },
    { id:'opv',   name:'bOPV Refuerzo', desc:'VO ¬∑ Oral',            syr:'oral',emoji:'üîµ', color:'bg-cyan'   },
    { id:'srp',   name:'SRP 2',          desc:'SC ¬∑ Subcut√°nea',     syr:'25G', emoji:'üü°', color:'bg-yellow' }
  ]
};

const NEXT_SCHEMA = { "0":"2","2":"4","4":"6","6":"12","12":"15","15":"18","18":null };

const BIO_NAMES = {
  bcg:'BCG', hb:'Hepatitis B', penta:'Pentavalente', fipv:'fIPV (Polio iny.)',
  opv:'bOPV (Polio oral)', rota:'Rotavirus', neumo:'Neumococo',
  flu:'Influenza', srp:'SRP', fa:'Fiebre Amarilla', vari:'Varicela', dpt:'DPT'
};
const JER_NAMES = { '23G':'Jeringa 23G (IM)', '25G':'Jeringa 25G (SC)', '27G':'Jeringa 27G (ID)' };

const STICKY_COLORS = ['bg-yellow','bg-blue','bg-green','bg-pink','bg-purple','bg-orange','bg-cyan'];

/* ===================================================
   ESTADO GLOBAL
   =================================================== */
let selectedVaccines = new Set();
let currentMovType   = 'bio';
let currentKdxType   = 'bio';
let currentFilter    = 'hoy';
let currentMovFilter = 'mes';

// Datos persistentes
let records    = JSON.parse(localStorage.getItem('vf2_records'))    || [];
let movements  = JSON.parse(localStorage.getItem('vf2_movements'))  || [];

const mkEmpty = () => ({ ing:0, apl:0, per:0, dev:0 });
let inventory = JSON.parse(localStorage.getItem('vf2_inventory')) || {
  bio: { bcg:mkEmpty(),hb:mkEmpty(),penta:mkEmpty(),fipv:mkEmpty(),opv:mkEmpty(),
         rota:mkEmpty(),neumo:mkEmpty(),flu:mkEmpty(),srp:mkEmpty(),fa:mkEmpty(),
         vari:mkEmpty(),dpt:mkEmpty() },
  jer: { '23G':mkEmpty(),'25G':mkEmpty(),'27G':mkEmpty() }
};

/* ===================================================
   INIT
   =================================================== */
function initApp() {
  // Tema guardado
  const savedTheme = localStorage.getItem('vf2_theme');
  if (savedTheme === 'dark') { document.body.classList.add('dark-mode'); document.getElementById('theme-btn').textContent = '‚òÄÔ∏è'; }

  // Fechas
  const today = todayStr();
  document.getElementById('header-date').textContent = fmtDate(today);
  document.getElementById('p-fecha').value    = today;
  document.getElementById('p-fecha').max      = today;
  document.getElementById('mov-fecha').value  = today;
  document.getElementById('mov-fecha').max    = today;
  document.getElementById('filter-date').max  = today;
  document.getElementById('quick-date').textContent = fmtDate(today);

  renderVaccines();
  renderQuickStats();
  renderQuickList();
  renderBadgeDiario();
  checkStockAlert();
  renderStorageInfo();
}

/* ===================================================
   HELPERS
   =================================================== */
function todayStr() { return new Date().toISOString().split('T')[0]; }

function fmtDate(str) {
  if (!str) return '';
  const [y,m,d] = str.split('-');
  const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  return `${d} ${months[parseInt(m)-1]} ${y}`;
}

function calcSaldo(item) {
  return (item.ing||0) - (item.apl||0) - (item.per||0) - (item.dev||0);
}

function getMonthStr() { return new Date().toISOString().substring(0,7); }

function getWeekRange() {
  const now = new Date();
  const day = now.getDay() || 7;
  const mon = new Date(now); mon.setDate(now.getDate() - day + 1);
  const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
  return { start: mon.toISOString().split('T')[0], end: sun.toISOString().split('T')[0] };
}

function filterRecords(f, dateVal) {
  const today = todayStr();
  const month = getMonthStr();
  const week  = getWeekRange();
  return records.filter(r => {
    if (f === 'hoy')    return r.dateApplied === today;
    if (f === 'semana') return r.dateApplied >= week.start && r.dateApplied <= week.end;
    if (f === 'mes')    return r.dateApplied.startsWith(month);
    if (f === 'fecha')  return r.dateApplied === dateVal;
    return true;
  });
}

function filterMovements(f) {
  const today = todayStr();
  const month = getMonthStr();
  const week  = getWeekRange();
  return movements.filter(m => {
    if (f === 'hoy')    return m.fecha === today;
    if (f === 'semana') return m.fecha >= week.start && m.fecha <= week.end;
    if (f === 'mes')    return m.fecha.startsWith(month);
    return true;
  });
}

function stickyColor(i) { return STICKY_COLORS[i % STICKY_COLORS.length]; }

function saveAll() {
  localStorage.setItem('vf2_records',   JSON.stringify(records));
  localStorage.setItem('vf2_movements', JSON.stringify(movements));
  localStorage.setItem('vf2_inventory', JSON.stringify(inventory));
}

/* ===================================================
   TEMA
   =================================================== */
function toggleTheme() {
  const dark = document.body.classList.toggle('dark-mode');
  document.getElementById('theme-btn').textContent = dark ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('vf2_theme', dark ? 'dark' : 'light');
}

/* ===================================================
   NAVEGACI√ìN TABS
   =================================================== */
function switchTab(id, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  if (btn) btn.classList.add('active');

  if (id === 'diario')     { renderDiario(); }
  if (id === 'kardex')     { renderKardex(); renderMovTable(); checkStockAlert(); }
  if (id === 'pendientes') { renderPendientes(); }
  if (id === 'reportes')   { renderReportStats(); renderStorageInfo(); }
}

/* ===================================================
   FECHA VALIDACI√ìN
   =================================================== */
function validateFecha() {
  const today = todayStr();
  const v = document.getElementById('p-fecha').value;
  const warn = document.getElementById('fecha-warn');
  if (v > today) {
    document.getElementById('p-fecha').value = today;
    warn.style.display = 'block';
    setTimeout(() => warn.style.display = 'none', 3000);
  }
}
function validateMovFecha() {
  const today = todayStr();
  const v = document.getElementById('mov-fecha').value;
  const warn = document.getElementById('mov-fecha-warn');
  if (v > today) {
    document.getElementById('mov-fecha').value = today;
    warn.style.display = 'block';
    setTimeout(() => warn.style.display = 'none', 3000);
  }
}

/* ===================================================
   TAB 1: VACUNAR
   =================================================== */
function calcEsquema() {
  const dob = document.getElementById('p-dob').value;
  if (!dob) return;
  const birth = new Date(dob + 'T00:00:00');
  const today = new Date();
  let months = (today.getFullYear() - birth.getFullYear()) * 12 + (today.getMonth() - birth.getMonth());
  if (today.getDate() < birth.getDate()) months--;
  months = Math.max(0, months);

  let s = '0';
  if      (months >= 18) s = '18';
  else if (months >= 15) s = '15';
  else if (months >= 12) s = '12';
  else if (months >= 6)  s = '6';
  else if (months >= 4)  s = '4';
  else if (months >= 2)  s = '2';

  document.getElementById('p-esquema').value = s;
  const label = s === '0' ? 'Reci√©n Nacido' : s + ' meses';
  const badge = document.getElementById('age-badge');
  badge.textContent = `üìÖ Edad: ${months} mes${months===1?'':'es'} ¬∑ Esquema sugerido: ${label}`;
  badge.style.display = 'block';
  renderVaccines();
}

function renderVaccines() {
  const esquema = document.getElementById('p-esquema').value;
  const container = document.getElementById('vaccine-selector');
  container.innerHTML = '';
  selectedVaccines.clear();
  updateSelCount();

  MSP_DB[esquema].forEach(v => {
    const div = document.createElement('div');
    div.className = 'vac-card';
    div.onclick = () => toggleVac(v, div);
    div.innerHTML = `
      <div class="vac-emoji">${v.emoji}</div>
      <div class="vac-info">
        <div class="vac-name">${v.name}</div>
        <div class="vac-meta">${v.desc}${v.syr !== 'oral' ? ' ¬∑ Jeringa ' + v.syr : ''}</div>
      </div>
      <div class="vac-check">‚úì</div>
    `;
    container.appendChild(div);
    toggleVac(v, div); // pre-select all
  });
}

function toggleVac(v, el) {
  if (selectedVaccines.has(v)) {
    selectedVaccines.delete(v); el.classList.remove('selected');
  } else {
    selectedVaccines.add(v); el.classList.add('selected');
  }
  updateSelCount();
}

function updateSelCount() {
  document.getElementById('sel-count').textContent = selectedVaccines.size + ' selec.';
}

function saveRecord() {
  const fecha  = document.getElementById('p-fecha').value;
  const name   = document.getElementById('p-name').value.trim();
  const dob    = document.getElementById('p-dob').value;
  const esquema = document.getElementById('p-esquema').value;

  if (!name) { shakeInput('p-name'); showToast('‚ö†Ô∏è Ingresa el nombre del paciente'); return; }
  if (!dob)  { shakeInput('p-dob');  showToast('‚ö†Ô∏è Ingresa la fecha de nacimiento'); return; }
  if (!fecha){ showToast('‚ö†Ô∏è Selecciona la fecha de aplicaci√≥n'); return; }
  if (selectedVaccines.size === 0) { showToast('‚ö†Ô∏è Selecciona al menos una vacuna'); return; }
  if (fecha > todayStr()) { showToast('‚ö†Ô∏è No se permiten fechas futuras'); return; }

  // Verificar stock antes de guardar
  let stockError = '';
  selectedVaccines.forEach(v => {
    if (v.syr !== 'oral') {
      const bio = inventory.bio[v.id];
      if (bio && calcSaldo(bio) <= 0) stockError += `\n‚Ä¢ ${v.name} sin stock`;
    }
  });
  if (stockError) {
    if (!confirm(`‚ö†Ô∏è Stock insuficiente en:${stockError}\n\n¬øDeseas registrar de todas formas?`)) return;
  }

  const vacsApplied = [...selectedVaccines];

  // Descontar inventario
  vacsApplied.forEach(v => {
    if (inventory.bio[v.id])               inventory.bio[v.id].apl++;
    if (v.syr !== 'oral' && inventory.jer[v.syr]) inventory.jer[v.syr].apl++;
  });

  const record = {
    id: Date.now(),
    dateApplied: fecha,
    name, dob,
    esquemaKey: esquema,
    esquema: esquema === '0' ? 'Reci√©n Nacido' : esquema + ' Meses',
    vaccines: vacsApplied.map(v => ({ id:v.id, name:v.name, desc:v.desc, syr:v.syr, emoji:v.emoji, color:v.color })),
    color: stickyColor(records.length)
  };
  records.push(record);
  saveAll();

  try {
    confetti({ particleCount: 120, spread: 70, origin: { y: 0.6 },
      colors: ['#667eea','#764ba2','#10b981','#f59e0b'] });
  } catch(e){}

  showToast(`‚úÖ ${name} registrado correctamente`);
  renderQuickStats(); renderQuickList(); renderBadgeDiario(); checkStockAlert();

  // Reset form
  document.getElementById('p-name').value = '';
  document.getElementById('p-dob').value  = '';
  document.getElementById('age-badge').style.display = 'none';
  document.getElementById('p-fecha').value = todayStr();
  renderVaccines();
}

function renderQuickStats() {
  const today = todayStr();
  const todayRecs = records.filter(r => r.dateApplied === today);
  const totalDoses = todayRecs.reduce((a,r) => a + r.vaccines.length, 0);
  const monthRecs = records.filter(r => r.dateApplied.startsWith(getMonthStr()));

  document.getElementById('quick-stats').innerHTML = `
    <div class="stat-card">
      <div class="stat-num" style="color:var(--accent-color)">${todayRecs.length}</div>
      <div class="stat-label">Ni√±os hoy</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--green)">${totalDoses}</div>
      <div class="stat-label">Dosis hoy</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--purple)">${monthRecs.length}</div>
      <div class="stat-label">Ni√±os mes</div>
    </div>
  `;
}

function renderQuickList() {
  const today = todayStr();
  const todayRecs = records.filter(r => r.dateApplied === today).slice().reverse().slice(0,5);
  const el = document.getElementById('quick-list');
  if (!todayRecs.length) {
    el.innerHTML = '<div class="empty-state" style="padding:20px"><div class="empty-icon">üíâ</div><div>Sin registros hoy a√∫n</div></div>';
    return;
  }
  el.innerHTML = todayRecs.map((r,i) => buildPatientCard(r, i, false)).join('');
}

/* ===================================================
   TAB 2: PARTE DIARIO
   =================================================== */
function setFilter(f, btn) {
  currentFilter = f;
  if (btn) {
    document.querySelectorAll('#tab-diario .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  renderDiario();
}

function renderDiario() {
  const search   = (document.getElementById('search-input').value || '').toLowerCase();
  const dateVal  = document.getElementById('filter-date').value;
  let recs       = filterRecords(currentFilter, dateVal);
  if (search) recs = recs.filter(r => r.name.toLowerCase().includes(search));
  recs = recs.slice().reverse();

  // Stats
  const totalDoses = recs.reduce((a,r) => a + r.vaccines.length, 0);
  const byEsquema  = {};
  recs.forEach(r => { byEsquema[r.esquema] = (byEsquema[r.esquema]||0) + 1; });
  const topEsquema = Object.entries(byEsquema).sort((a,b)=>b[1]-a[1])[0];

  document.getElementById('diario-stats').innerHTML = `
    <div class="stat-card">
      <div class="stat-num" style="color:var(--accent-color)">${recs.length}</div>
      <div class="stat-label">Pacientes</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--green)">${totalDoses}</div>
      <div class="stat-label">Dosis</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--orange)">${topEsquema ? topEsquema[0].replace(' Meses','m').replace('Reci√©n Nacido','RN') : '‚Äî'}</div>
      <div class="stat-label">Esquema top</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--purple)">${[...new Set(recs.flatMap(r=>r.vaccines.map(v=>v.id)))].length}</div>
      <div class="stat-label">Biol√≥gicos</div>
    </div>
  `;

  const list = document.getElementById('patient-list');
  const empty = document.getElementById('empty-diario');
  if (!recs.length) {
    list.innerHTML = ''; empty.classList.remove('hidden'); return;
  }
  empty.classList.add('hidden');
  list.innerHTML = recs.map((r,i) => buildPatientCard(r, i, true)).join('');
}

function buildPatientCard(r, i, showDelete) {
  const tags = r.vaccines.map(v =>
    `<span class="pc-tag" style="background:rgba(102,126,234,0.12);color:var(--accent-color)">${v.emoji} ${v.name}</span>`
  ).join('');
  const del = showDelete
    ? `<button class="icon-btn" onclick="deleteRecord(${r.id})" title="Eliminar">üóëÔ∏è</button>`
    : '';
  return `
    <div class="patient-card ${r.color || stickyColor(i)}" style="animation:popIn 0.35s ease ${i*0.05}s both">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
        <div style="flex:1;min-width:0">
          <div class="pc-name">${r.name}</div>
          <div class="pc-meta">üìÖ ${fmtDate(r.dateApplied)} ¬∑ Esquema: ${r.esquema}</div>
          <div class="pc-tags">${tags}</div>
        </div>
        <div style="display:flex;gap:4px">${del}</div>
      </div>
    </div>
  `;
}

function deleteRecord(id) {
  if (!confirm('¬øEliminar este registro? El stock descontado no se revertir√° autom√°ticamente.')) return;
  records = records.filter(r => r.id !== id);
  saveAll();
  renderDiario(); renderQuickStats(); renderQuickList(); renderBadgeDiario();
  showToast('üóëÔ∏è Registro eliminado');
}

function renderBadgeDiario() {
  const count = records.filter(r => r.dateApplied === todayStr()).length;
  document.getElementById('badge-diario').textContent = count;
}

/* ===================================================
   TAB 3: KARDEX
   =================================================== */
function renderKardex() {
  renderKdxSection('bio', 'inv-biologicos', BIO_NAMES);
  renderKdxSection('jer', 'inv-jeringas',   JER_NAMES);
}

function renderKdxSection(type, containerId, names) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  const dict = inventory[type];

  for (const [key, data] of Object.entries(dict)) {
    const saldo = calcSaldo(data);
    let cls = saldo <= 0 ? 'danger' : saldo <= 5 ? 'warn' : '';

    const card = document.createElement('div');
    card.className = `kdx-card ${cls}`;
    card.onclick   = () => openKdxDetail(key, type, names[key]);
    card.innerHTML = `
      <div class="kdx-name">${names[key]}</div>
      <div class="kdx-saldo">${saldo}</div>
      <div class="kdx-mini">
        <span>I:${data.ing}</span>
        <span>A:${data.apl}</span>
        <span>P:${data.per}</span>
        <span>D:${data.dev}</span>
      </div>
    `;
    container.appendChild(card);
  }
}

function openKdxDetail(key, type, name) {
  currentKdxType = type;
  const data  = inventory[type][key];
  const saldo = calcSaldo(data);
  const allNames = {...BIO_NAMES, ...JER_NAMES};

  document.getElementById('kdx-detail-title').textContent = name;
  document.getElementById('kdx-detail-body').innerHTML = `
    <div style="text-align:center;margin-bottom:18px;">
      <div style="font-family:'Indie Flower',cursive;font-size:3.5rem;color:${saldo<=0?'var(--red)':saldo<=5?'var(--orange)':'var(--green)'};">${saldo}</div>
      <div style="font-size:0.75rem;font-weight:800;color:var(--empty-text);text-transform:uppercase;letter-spacing:1px;">Saldo actual (dosis/unidades)</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
      <div style="background:rgba(5,150,105,0.08);border-radius:12px;padding:12px;text-align:center;">
        <div style="font-family:'Indie Flower',cursive;font-size:2rem;color:var(--green);">${data.ing}</div>
        <div style="font-size:0.65rem;font-weight:800;color:var(--empty-text);text-transform:uppercase;">üì• Ingresos</div>
      </div>
      <div style="background:rgba(124,58,237,0.08);border-radius:12px;padding:12px;text-align:center;">
        <div style="font-family:'Indie Flower',cursive;font-size:2rem;color:var(--purple);">${data.apl}</div>
        <div style="font-size:0.65rem;font-weight:800;color:var(--empty-text);text-transform:uppercase;">üíâ Aplicadas</div>
      </div>
      <div style="background:rgba(220,38,38,0.08);border-radius:12px;padding:12px;text-align:center;">
        <div style="font-family:'Indie Flower',cursive;font-size:2rem;color:var(--red);">${data.per}</div>
        <div style="font-size:0.65rem;font-weight:800;color:var(--empty-text);text-transform:uppercase;">‚ö†Ô∏è P√©rdidas</div>
      </div>
      <div style="background:rgba(37,99,235,0.08);border-radius:12px;padding:12px;text-align:center;">
        <div style="font-family:'Indie Flower',cursive;font-size:2rem;color:var(--blue);">${data.dev}</div>
        <div style="font-size:0.65rem;font-weight:800;color:var(--empty-text);text-transform:uppercase;">üì§ Devueltos</div>
      </div>
    </div>
    <div style="font-size:0.72rem;font-weight:700;color:var(--empty-text);text-align:center;">
      Saldo = Ingresos (${data.ing}) ‚àí Aplicadas (${data.apl}) ‚àí P√©rdidas (${data.per}) ‚àí Devueltos (${data.dev}) = <strong>${saldo}</strong>
    </div>
  `;
  openModal('modal-kdx-detail');
}

/* ===================================================
   MODAL MOVIMIENTO
   =================================================== */
function openMovModal(type) {
  currentMovType = type;
  const names    = type === 'bio' ? BIO_NAMES : JER_NAMES;
  const dict     = inventory[type];
  const select   = document.getElementById('mov-item');
  select.innerHTML = Object.entries(dict).map(([k]) =>
    `<option value="${k}">${names[k]}</option>`
  ).join('');

  document.getElementById('modal-mov-title').textContent =
    type === 'bio' ? 'üß™ Registrar Movimiento ‚Äî Biol√≥gico' : 'üíâ Registrar Movimiento ‚Äî Jeringa';
  document.getElementById('mov-fecha').value = todayStr();
  document.getElementById('mov-fecha').max   = todayStr();
  document.getElementById('mov-cantidad').value = '';
  document.getElementById('mov-obs').value   = '';
  document.getElementById('mov-tipo').value  = 'ingreso';
  toggleCausa();
  openModal('modal-mov');
}

function toggleCausa() {
  const tipo  = document.getElementById('mov-tipo').value;
  const grupo = document.getElementById('causa-group');
  grupo.style.display = tipo === 'perdida' ? 'block' : 'none';
}

function saveMovimiento() {
  const fecha    = document.getElementById('mov-fecha').value;
  const item     = document.getElementById('mov-item').value;
  const tipo     = document.getElementById('mov-tipo').value;
  const cantidad = parseInt(document.getElementById('mov-cantidad').value) || 0;
  const causa    = document.getElementById('mov-causa').value;
  const obs      = document.getElementById('mov-obs').value.trim();

  if (!fecha)          { showToast('‚ö†Ô∏è Selecciona la fecha'); return; }
  if (fecha > todayStr()) { showToast('‚ö†Ô∏è No se permiten fechas futuras'); return; }
  if (cantidad <= 0)   { shakeInput('mov-cantidad'); showToast('‚ö†Ô∏è Ingresa una cantidad v√°lida'); return; }
  if (tipo === 'perdida' && !causa) { shakeInput('mov-causa'); showToast('‚ö†Ô∏è Debes indicar la causa de la p√©rdida'); return; }

  const names = currentMovType === 'bio' ? BIO_NAMES : JER_NAMES;

  // Verificar que p√©rdida/devoluci√≥n no supere saldo
  if (tipo !== 'ingreso') {
    const saldo = calcSaldo(inventory[currentMovType][item]);
    if (cantidad > saldo) {
      if (!confirm(`‚ö†Ô∏è La cantidad (${cantidad}) supera el saldo actual (${saldo}). ¬øContinuar de todas formas?`)) return;
    }
  }

  // Actualizar inventario
  if (tipo === 'ingreso')   inventory[currentMovType][item].ing += cantidad;
  if (tipo === 'perdida')   inventory[currentMovType][item].per += cantidad;
  if (tipo === 'devolucion') inventory[currentMovType][item].dev += cantidad;

  // Guardar movimiento en historial
  movements.push({
    id: Date.now(),
    fecha, tipo,
    itemKey: item,
    itemName: names[item],
    itemType: currentMovType,
    cantidad,
    causa: tipo === 'perdida' ? causa : '',
    obs
  });

  saveAll();
  closeModal('modal-mov');
  renderKardex();
  renderMovTable();
  checkStockAlert();

  const tipoLabel = tipo === 'ingreso' ? 'üì• Ingreso' : tipo === 'perdida' ? '‚ö†Ô∏è P√©rdida' : 'üì§ Devoluci√≥n';
  showToast(`${tipoLabel} registrado: ${cantidad} √ó ${names[item]}`);
}

/* ===================================================
   TABLA DE MOVIMIENTOS
   =================================================== */
function setMovFilter(f, btn) {
  currentMovFilter = f;
  if (btn) {
    document.querySelectorAll('#tab-kardex .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  renderMovTable();
}

function renderMovTable() {
  const movs  = currentMovFilter === 'todo' ? movements : filterMovements(currentMovFilter);
  const tbody = document.getElementById('mov-tbody');
  const empty = document.getElementById('empty-movs');

  if (!movs.length) {
    tbody.innerHTML = ''; empty.classList.remove('hidden'); return;
  }
  empty.classList.add('hidden');
  tbody.innerHTML = movs.slice().reverse().map(m => {
    const tipoClass = m.tipo === 'ingreso' ? 'mov-ingreso' : m.tipo === 'perdida' ? 'mov-perdida' : 'mov-devolucion';
    const tipoLabel = m.tipo === 'ingreso' ? 'üì• Ingreso' : m.tipo === 'perdida' ? '‚ö†Ô∏è P√©rdida' : 'üì§ Devoluci√≥n';
    const sign      = m.tipo === 'ingreso' ? '+' : '‚àí';
    return `
      <tr>
        <td style="white-space:nowrap">${fmtDate(m.fecha)}</td>
        <td style="font-weight:800">${m.itemName}</td>
        <td><span class="mov-type ${tipoClass}">${tipoLabel}</span></td>
        <td style="font-weight:900;color:${m.tipo==='ingreso'?'var(--green)':'var(--red)'}">${sign}${m.cantidad}</td>
        <td style="font-size:0.75rem;color:var(--empty-text)">${m.causa || m.obs || '‚Äî'}</td>
      </tr>
    `;
  }).join('');
}

/* ===================================================
   STOCK ALERT
   =================================================== */
function checkStockAlert() {
  const critical = [];
  Object.entries(inventory.bio).forEach(([k,v]) => {
    if (calcSaldo(v) <= 5) critical.push(BIO_NAMES[k]);
  });
  Object.entries(inventory.jer).forEach(([k,v]) => {
    if (calcSaldo(v) <= 5) critical.push(JER_NAMES[k]);
  });

  const headerAlert = document.getElementById('stock-alert-header');
  const kardexAlert = document.getElementById('stock-alert-kardex');
  if (critical.length) {
    headerAlert.style.display = 'block';
    headerAlert.textContent   = `‚ö†Ô∏è Stock cr√≠tico: ${critical.join(', ')}`;
    kardexAlert.style.display = 'block';
    kardexAlert.textContent   = `‚ö†Ô∏è Stock bajo (‚â§5): ${critical.join(' ¬∑ ')}`;
  } else {
    headerAlert.style.display = 'none';
    kardexAlert.style.display = 'none';
  }
}

/* ===================================================
   CIERRE DE MES
   =================================================== */
function closeMonth() {
  const month = getMonthStr();
  const monthRecs = records.filter(r => r.dateApplied.startsWith(month));

  if (!confirm(`‚ö†Ô∏è CIERRE DE MES\n\nEsto guardar√° el reporte de ${month} y reiniciar√° los contadores del Kardex para el nuevo mes.\n\nEl historial de ${monthRecs.length} pacientes se conserva.\n\n¬øContinuar?`)) return;

  // Guardar snapshot del mes (sin borrar records)
  const snapKey = `vf2_snap_${month}`;
  localStorage.setItem(snapKey, JSON.stringify({
    month, inventory: JSON.parse(JSON.stringify(inventory)), records: monthRecs
  }));

  // Reiniciar inventario (solo ing/per/dev; apl persiste pero tambi√©n se reinicia)
  Object.keys(inventory.bio).forEach(k => inventory.bio[k] = mkEmpty());
  Object.keys(inventory.jer).forEach(k => inventory.jer[k] = mkEmpty());

  saveAll();
  renderKardex();
  showToast(`‚úÖ Mes ${month} cerrado. Kardex reiniciado para el nuevo mes.`);
}

/* ===================================================
   PENDIENTES
   =================================================== */
function renderPendientes() {
  const today = new Date();
  // Obtener el √∫ltimo registro de cada paciente por nombre
  const byName = {};
  records.forEach(r => {
    if (!byName[r.name] || r.dateApplied > byName[r.name].dateApplied) byName[r.name] = r;
  });

  const pending = [];
  Object.values(byName).forEach(r => {
    const nextKey = NEXT_SCHEMA[r.esquemaKey];
    if (!nextKey) return; // ya complet√≥ el esquema al d√≠a

    const dob = new Date(r.dob + 'T00:00:00');
    const months = (today.getFullYear() - dob.getFullYear()) * 12 + (today.getMonth() - dob.getMonth());
    const nextAge = parseInt(nextKey);

    if (months >= nextAge) {
      const nextVacs = MSP_DB[nextKey] ? MSP_DB[nextKey].map(v => v.name) : [];
      pending.push({ ...r, nextEsquema: nextKey === '0' ? 'Reci√©n Nacido' : nextKey + ' Meses', nextVacs, monthsOld: months });
    }
  });

  const container = document.getElementById('pendientes-list');
  const empty     = document.getElementById('empty-pendientes');
  if (!pending.length) {
    container.innerHTML = ''; empty.classList.remove('hidden'); return;
  }
  empty.classList.add('hidden');
  container.innerHTML = pending.map(p => `
    <div class="pending-card">
      <div style="flex:1">
        <div class="pending-name">${p.name}</div>
        <div class="pending-info">Edad: ${p.monthsOld} meses ¬∑ √öltimo esquema: ${p.esquema}</div>
        <div class="pending-chips">
          <span style="font-size:0.65rem;font-weight:800;padding:2px 8px;border-radius:10px;background:rgba(220,38,38,0.12);color:var(--red);">
            Pendiente: ${p.nextEsquema}
          </span>
          ${p.nextVacs.map(v=>`<span class="pending-chip">${v}</span>`).join('')}
        </div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="prefillPatient('${p.name}','${p.dob}','${p.nextEsquema}','${p.nextKey||p.esquemaKey}')">
        Vacunar ‚Üí
      </button>
    </div>
  `).join('');
}

function prefillPatient(name, dob, esquemaLabel, esquemaKey) {
  switchTab('vacunar', document.querySelector('.tab-btn'));
  document.querySelector('.tab-btn').classList.add('active');
  setTimeout(() => {
    document.getElementById('p-name').value   = name;
    document.getElementById('p-dob').value    = dob;
    // Find the esquema key from label
    const allKeys = Object.keys(MSP_DB);
    const key = allKeys.find(k => {
      const lbl = k === '0' ? 'Reci√©n Nacido' : k + ' Meses';
      return lbl === esquemaLabel;
    }) || '0';
    document.getElementById('p-esquema').value = key;
    renderVaccines();
    showToast(`üìã ${name} cargado ‚Äî esquema ${esquemaLabel}`);
  }, 150);
}

/* ===================================================
   REPORTES
   =================================================== */
function renderReportStats() {
  const month    = getMonthStr();
  const monthRecs = records.filter(r => r.dateApplied.startsWith(month));
  const totalDoses = monthRecs.reduce((a,r) => a + r.vaccines.length, 0);
  const totalLoss  = Object.values(inventory.bio).reduce((a,v) => a + v.per, 0);
  const totalIng   = Object.values(inventory.bio).reduce((a,v) => a + v.ing, 0);
  const totalDev   = Object.values(inventory.bio).reduce((a,v) => a + v.dev, 0);

  document.getElementById('report-stats').innerHTML = `
    <div class="stat-card">
      <div class="stat-num" style="color:var(--accent-color)">${monthRecs.length}</div>
      <div class="stat-label">Ni√±os vacunados</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--green)">${totalDoses}</div>
      <div class="stat-label">Dosis aplicadas</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--blue)">${totalIng}</div>
      <div class="stat-label">Biol√≥gicos recibidos</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--orange)">${totalDev}</div>
      <div class="stat-label">Devuelto al distrito</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--red)">${totalLoss}</div>
      <div class="stat-label">P√©rdidas</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:var(--purple)">${movements.filter(m=>m.fecha.startsWith(month)).length}</div>
      <div class="stat-label">Movimientos</div>
    </div>
  `;
}

function renderStorageInfo() {
  try {
    const used = Object.keys(localStorage)
      .filter(k => k.startsWith('vf2_'))
      .reduce((a,k) => a + localStorage.getItem(k).length, 0);
    const kb = (used / 1024).toFixed(1);
    document.getElementById('storage-info').innerHTML = `
      üì¶ ${records.length} pacientes registrados<br>
      üì¶ ${movements.length} movimientos de inventario<br>
      üíæ ~${kb} KB usados localmente en este dispositivo
    `;
  } catch(e) {}
}

/* ===================================================
   EXCEL EXPORTS
   =================================================== */
function makeWB() { return XLSX.utils.book_new(); }
function makeWS(data, cols) {
  const ws = XLSX.utils.json_to_sheet(data);
  if (cols) ws['!cols'] = cols;
  return ws;
}
function dl(wb, name) {
  XLSX.writeFile(wb, name);
  try { confetti({ particleCount:140, spread:75, origin:{y:0.6}, colors:['#667eea','#764ba2','#10b981','#f59e0b'] }); } catch(e){}
  showToast(`üì• ${name} descargado`);
}

function exportPatients() {
  const month = getMonthStr();
  const recs  = records.filter(r => r.dateApplied.startsWith(month));
  if (!recs.length) { showToast('‚ö†Ô∏è Sin registros este mes'); return; }
  const data = recs.map(r => ({
    'FECHA APLICACI√ìN': r.dateApplied,
    'FECHA (FORMATO)':  fmtDate(r.dateApplied),
    'APELLIDOS Y NOMBRES': r.name,
    'FECHA NACIMIENTO': r.dob,
    'ESQUEMA': r.esquema,
    'VACUNAS ADMINISTRADAS': r.vaccines.map(v=>v.name).join(' + '),
    'N¬∞ DOSIS': r.vaccines.length,
    'V√çAS': r.vaccines.map(v=>v.desc).join(' / ')
  }));
  const wb = makeWB();
  XLSX.utils.book_append_sheet(wb, makeWS(data,[{wch:15},{wch:16},{wch:32},{wch:15},{wch:14},{wch:50},{wch:8},{wch:30}]), 'Pacientes');
  dl(wb, `VacuFlow_Pacientes_${month}.xlsx`);
}

function exportKardex() {
  const month = getMonthStr();
  const data  = [];
  Object.entries(inventory.bio).forEach(([k,v]) => {
    data.push({
      'BIOL√ìGICO':            BIO_NAMES[k],
      'INGRESOS (Recibidos)': v.ing,
      'APLICADAS (Egresos)':  v.apl,
      'P√âRDIDAS (Descarte)':  v.per,
      'DEVOLUCIONES':         v.dev,
      'SALDO ACTUAL':         calcSaldo(v)
    });
  });
  const wb = makeWB();
  XLSX.utils.book_append_sheet(wb, makeWS(data,[{wch:24},{wch:18},{wch:18},{wch:18},{wch:14},{wch:14}]), 'Kardex Biol√≥gicos');
  dl(wb, `VacuFlow_Kardex_${month}.xlsx`);
}

function exportJeringas() {
  const month = getMonthStr();
  const data  = Object.entries(inventory.jer).map(([k,v]) => ({
    'JERINGA':              JER_NAMES[k],
    'INGRESOS (Recibidas)': v.ing,
    'USADAS (Egresos)':     v.apl,
    'P√âRDIDAS':             v.per,
    'DEVOLUCIONES':         v.dev,
    'SALDO ACTUAL':         calcSaldo(v)
  }));
  const wb = makeWB();
  XLSX.utils.book_append_sheet(wb, makeWS(data,[{wch:22},{wch:16},{wch:16},{wch:12},{wch:14},{wch:14}]), 'Jeringas');
  dl(wb, `VacuFlow_Jeringas_${month}.xlsx`);
}

function exportMovimientos() {
  if (!movements.length) { showToast('‚ö†Ô∏è Sin movimientos registrados'); return; }
  const data = movements.slice().reverse().map(m => ({
    'FECHA':     m.fecha,
    'FECHA (FORMATO)': fmtDate(m.fecha),
    'INSUMO':    m.itemName,
    'TIPO':      m.tipo === 'ingreso' ? 'Ingreso' : m.tipo === 'perdida' ? 'P√©rdida/Descarte' : 'Devoluci√≥n',
    'CANTIDAD':  m.tipo === 'ingreso' ? m.cantidad : -m.cantidad,
    'CAUSA':     m.causa || '',
    'OBSERVACIONES': m.obs || ''
  }));
  const wb = makeWB();
  XLSX.utils.book_append_sheet(wb, makeWS(data,[{wch:12},{wch:16},{wch:24},{wch:18},{wch:10},{wch:28},{wch:30}]), 'Movimientos');
  dl(wb, `VacuFlow_Movimientos.xlsx`);
}

function exportCompleto() {
  const month    = getMonthStr();
  const monthRecs = records.filter(r => r.dateApplied.startsWith(month));
  const wb = makeWB();

  // Hoja 1: Pacientes
  if (monthRecs.length) {
    const d = monthRecs.map(r => ({
      'FECHA': r.dateApplied, 'PACIENTE': r.name,
      'F. NAC.': r.dob, 'ESQUEMA': r.esquema,
      'VACUNAS': r.vaccines.map(v=>v.name).join(' + '), 'N¬∞ DOSIS': r.vaccines.length
    }));
    XLSX.utils.book_append_sheet(wb, makeWS(d,[{wch:12},{wch:30},{wch:14},{wch:14},{wch:46},{wch:8}]), '1. Pacientes');
  }

  // Hoja 2: Biol√≥gicos
  const dBio = Object.entries(inventory.bio).map(([k,v]) => ({
    'BIOL√ìGICO': BIO_NAMES[k], 'INGRESOS': v.ing, 'APLICADAS': v.apl,
    'P√âRDIDAS': v.per, 'DEVUELTOS': v.dev, 'SALDO': calcSaldo(v)
  }));
  XLSX.utils.book_append_sheet(wb, makeWS(dBio,[{wch:22},{wch:10},{wch:10},{wch:10},{wch:10},{wch:10}]), '2. Biol√≥gicos');

  // Hoja 3: Jeringas
  const dJer = Object.entries(inventory.jer).map(([k,v]) => ({
    'JERINGA': JER_NAMES[k], 'INGRESOS': v.ing, 'USADAS': v.apl,
    'P√âRDIDAS': v.per, 'DEVUELTAS': v.dev, 'SALDO': calcSaldo(v)
  }));
  XLSX.utils.book_append_sheet(wb, makeWS(dJer,[{wch:22},{wch:10},{wch:10},{wch:10},{wch:10},{wch:10}]), '3. Jeringas');

  // Hoja 4: Movimientos
  if (movements.length) {
    const dMov = movements.slice().reverse().map(m => ({
      'FECHA': m.fecha, 'INSUMO': m.itemName,
      'TIPO': m.tipo === 'ingreso' ? 'Ingreso' : m.tipo === 'perdida' ? 'P√©rdida' : 'Devoluci√≥n',
      'CANTIDAD': m.tipo === 'ingreso' ? m.cantidad : -m.cantidad,
      'CAUSA': m.causa || '', 'OBS': m.obs || ''
    }));
    XLSX.utils.book_append_sheet(wb, makeWS(dMov,[{wch:12},{wch:22},{wch:12},{wch:10},{wch:28},{wch:28}]), '4. Movimientos');
  }

  // Hoja 5: Resumen
  const totalDoses = monthRecs.reduce((a,r)=>a+r.vaccines.length,0);
  const dRes = [
    {'INDICADOR':'Mes','VALOR':month},
    {'INDICADOR':'Ni√±os vacunados','VALOR':monthRecs.length},
    {'INDICADOR':'Total dosis aplicadas','VALOR':totalDoses},
    {'INDICADOR':'Biol√≥gicos recibidos','VALOR':Object.values(inventory.bio).reduce((a,v)=>a+v.ing,0)},
    {'INDICADOR':'Biol√≥gicos devueltos al Distrito','VALOR':Object.values(inventory.bio).reduce((a,v)=>a+v.dev,0)},
    {'INDICADOR':'P√©rdidas de biol√≥gicos','VALOR':Object.values(inventory.bio).reduce((a,v)=>a+v.per,0)},
    {'INDICADOR':'Jeringas usadas (23G)','VALOR':inventory.jer['23G'].apl},
    {'INDICADOR':'Jeringas usadas (25G)','VALOR':inventory.jer['25G'].apl},
    {'INDICADOR':'Jeringas usadas (27G)','VALOR':inventory.jer['27G'].apl},
  ];
  XLSX.utils.book_append_sheet(wb, makeWS(dRes,[{wch:36},{wch:14}]), '5. Resumen MSP');

  dl(wb, `VacuFlow_ReporteMSP_${month}.xlsx`);
}

/* ===================================================
   MODAL HELPERS
   =================================================== */
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('show');
  });
});

/* ===================================================
   UTILS
   =================================================== */
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => toast.classList.remove('show'), 3200);
}

function shakeInput(id) {
  const el = document.getElementById(id);
  el.classList.remove('shake'); void el.offsetWidth;
  el.classList.add('shake');
  el.addEventListener('animationend', () => el.classList.remove('shake'), { once: true });
  el.focus();
}

function clearAllData() {
  if (!confirm('‚ö†Ô∏è ATENCI√ìN\n\nEsto eliminar√° TODOS los datos: pacientes, inventario e historial de movimientos.\n\nEsta acci√≥n NO se puede deshacer.\n\n¬øEst√°s seguro?')) return;
  Object.keys(localStorage).filter(k => k.startsWith('vf2_')).forEach(k => localStorage.removeItem(k));
  showToast('üóëÔ∏è Todos los datos han sido eliminados');
  setTimeout(() => location.reload(), 1500);
}

/* ===================================================
   START
   =================================================== */
window.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
