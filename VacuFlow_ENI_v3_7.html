<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#667eea">
<title>VacuFlow ENI ¬∑ MSP Ecuador</title>
<link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
/* ===================================================
   VARIABLES ‚Äî TaskFlow palette exacta
   =================================================== */
:root {
  --bg-color:          #f0f4f8;
  --text-color:        #2d3748;
  --grid-dot:          #cbd5e0;
  --glass-bg:          rgba(255,255,255,0.72);
  --glass-border:      1px solid rgba(255,255,255,0.7);
  --shadow-soft:       0 8px 32px 0 rgba(31,38,135,0.07);
  --accent-color:      #667eea;
  --accent2:           #764ba2;
  --btn-bg:            #fff;
  --btn-text:          #2d3748;
  --modal-bg:          rgba(255,255,255,0.98);
  --col-header-bg:     rgba(255,255,255,0.85);
  --input-bg:          #fff;
  --empty-text:        #a0aec0;
  --tape-color:        rgba(255,255,255,0.55);
  --surface:           rgba(255,255,255,0.85);
  --border-light:      rgba(203,213,224,0.6);
  --green:             #059669;
  --red:               #dc2626;
  --orange:            #d97706;
  --blue:              #2563eb;
  --purple:            #7c3aed;
}
.dark-mode {
  --bg-color:          #1a202c;
  --text-color:        #e2e8f0;
  --grid-dot:          #4a5568;
  --glass-bg:          rgba(26,32,44,0.65);
  --glass-border:      1px solid rgba(255,255,255,0.09);
  --shadow-soft:       0 8px 32px 0 rgba(0,0,0,0.45);
  --accent-color:      #a3bffa;
  --accent2:           #b794f4;
  --btn-bg:            #2d3748;
  --btn-text:          #e2e8f0;
  --modal-bg:          rgba(26,32,44,0.98);
  --col-header-bg:     rgba(45,55,72,0.85);
  --input-bg:          #2d3748;
  --empty-text:        #5f6c80;
  --tape-color:        rgba(255,255,255,0.12);
  --surface:           rgba(45,55,72,0.8);
  --border-light:      rgba(74,85,104,0.6);
  --green:             #34d399;
  --red:               #f87171;
  --orange:            #fbbf24;
  --blue:              #60a5fa;
  --purple:            #a78bfa;
}

/* ===================================================
   ANIMACIONES
   =================================================== */
@keyframes popIn {
  0%   { transform: scale(0.4) rotate(-5deg); opacity: 0; }
  65%  { transform: scale(1.08) rotate(1deg); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}
@keyframes fadeSlideUp {
  from { opacity: 0; transform: translateY(16px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes headerIn {
  from { opacity: 0; transform: translateY(-18px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes tabIn {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes shake {
  0%,100% { transform: translateX(0); }
  20%     { transform: translateX(-8px); }
  40%     { transform: translateX(8px); }
  60%     { transform: translateX(-5px); }
  80%     { transform: translateX(5px); }
}
@keyframes pulse {
  0%,100% { transform: scale(1); }
  50%     { transform: scale(1.18); }
}
@keyframes badgePulse {
  0%,100% { transform: scale(1); }
  50%     { transform: scale(1.35); }
}

/* ===================================================
   BASE
   =================================================== */
*,*::before,*::after { box-sizing: border-box; margin: 0; padding: 0; }
html { -webkit-text-size-adjust: 100%; }

body {
  font-family: 'Nunito', 'Segoe UI', sans-serif;
  background-color: var(--bg-color);
  background-image: radial-gradient(var(--grid-dot) 1.5px, transparent 1.5px);
  background-size: 25px 25px;
  color: var(--text-color);
  min-height: 100vh;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  transition: background-color 0.4s, color 0.3s;
  -webkit-tap-highlight-color: transparent;
}

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb {
  background: rgba(156,163,175,0.4);
  border-radius: 8px; border: 2px solid transparent;
  background-clip: content-box;
}

/* ===================================================
   HEADER
   =================================================== */
header {
  padding: 10px 20px;
  display: grid;
  grid-template-columns: auto 1fr auto;
  align-items: center; gap: 10px;
  background: var(--glass-bg);
  backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  border-bottom: var(--glass-border);
  position: sticky; top: 0; z-index: 500;
  box-shadow: 0 2px 20px rgba(0,0,0,0.05);
  animation: headerIn 0.5s ease forwards;
  transition: background 0.4s;
}
.header-left { display: flex; align-items: center; gap: 8px; }
.logo {
  font-family: 'Indie Flower', cursive;
  font-size: 2rem; font-weight: 700;
  background: linear-gradient(135deg, #667eea, #764ba2);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 2px 4px rgba(102,126,234,0.2));
  cursor: default; letter-spacing: -0.5px;
}
.version-tag {
  font-size: 0.75rem; font-weight: 800;
  color: var(--accent-color); -webkit-text-fill-color: var(--accent-color); background: none;
}
.header-center { text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap; }
.header-right { display: flex; align-items: center; justify-content: flex-end; gap: 8px; }

.alert-bar-stock {
  background: rgba(220,38,38,0.1); border: 1px solid rgba(220,38,38,0.3);
  border-radius: 10px; padding: 5px 12px;
  font-size: 0.73rem; font-weight: 800; color: var(--red);
  display: none; white-space: nowrap;
}
.alert-bar-expiry {
  background: rgba(217,119,6,0.1); border: 1px solid rgba(217,119,6,0.35);
  border-radius: 10px; padding: 5px 12px;
  font-size: 0.73rem; font-weight: 800; color: var(--orange);
  display: none; white-space: nowrap;
}

.ctrl-btn {
  padding: 6px 14px; border-radius: 12px;
  border: 1px solid var(--grid-dot);
  background: var(--btn-bg); color: var(--btn-text);
  cursor: pointer; font-family: 'Nunito', sans-serif;
  font-size: 0.82rem; font-weight: 700; outline: none;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  transition: transform 0.15s, box-shadow 0.2s, background 0.3s;
  white-space: nowrap;
}
.ctrl-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 14px rgba(0,0,0,0.1); }
.ctrl-btn:active { transform: scale(0.94); }
.date-badge {
  font-size: 0.78rem; font-weight: 800;
  background: linear-gradient(135deg,#667eea22,#764ba222);
  border: 1px solid var(--accent-color); color: var(--accent-color);
  padding: 5px 12px; border-radius: 20px; white-space: nowrap;
}

/* ===================================================
   TABS NAV
   =================================================== */
.tabs-nav {
  display: flex; justify-content: center; gap: 6px;
  padding: 12px 16px 0;
  flex-wrap: wrap;
}
.tab-btn {
  padding: 8px 18px; border-radius: 30px;
  border: 2px solid var(--border-light);
  background: var(--glass-bg); color: var(--text-color);
  cursor: pointer; font-family: 'Nunito', sans-serif;
  font-size: 0.82rem; font-weight: 800; outline: none;
  backdrop-filter: blur(10px);
  transition: all 0.25s; white-space: nowrap;
  display: flex; align-items: center; gap: 6px;
}
.tab-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 14px rgba(102,126,234,0.15); }
.tab-btn.active {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white; border-color: transparent;
  box-shadow: 0 6px 20px rgba(118,75,162,0.35);
  transform: translateY(-1px);
}
.tab-badge {
  background: rgba(255,255,255,0.3); color: white;
  font-size: 0.68rem; font-weight: 900;
  padding: 1px 7px; border-radius: 10px; min-width: 20px; text-align: center;
}
.tab-btn:not(.active) .tab-badge { background: var(--accent-color); color: white; }

/* ===================================================
   CONTENT √ÅREA
   =================================================== */
.content-area {
  flex: 1; padding: 14px 16px 80px;
  max-width: 1100px; margin: 0 auto; width: 100%;
}
.tab-panel { display: none; animation: tabIn 0.35s ease; }
.tab-panel.active { display: block; }

/* ===================================================
   GLASS CARD
   =================================================== */
.glass-card {
  background: var(--glass-bg);
  backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  border: var(--glass-border); border-radius: 20px;
  box-shadow: var(--shadow-soft);
  transition: background 0.4s, box-shadow 0.3s;
}
.card-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 16px; flex-wrap: wrap; gap: 8px;
}
.card-title {
  font-family: 'Indie Flower', cursive;
  font-size: 1.5rem; color: var(--accent-color);
  display: flex; align-items: center; gap: 8px;
}
.card-subtitle {
  font-size: 0.75rem; font-weight: 700;
  color: var(--empty-text); text-transform: uppercase; letter-spacing: 1px;
}

/* ===================================================
   FORM FIELDS
   =================================================== */
.field-group { margin-bottom: 14px; }
.field-label {
  display: block; font-size: 0.72rem; font-weight: 800;
  color: var(--empty-text); text-transform: uppercase;
  letter-spacing: 1.2px; margin-bottom: 6px; margin-left: 4px;
}
.field-input {
  width: 100%; padding: 11px 16px;
  border-radius: 14px; border: 2px solid transparent;
  background: linear-gradient(var(--input-bg),var(--input-bg)) padding-box,
              linear-gradient(135deg,var(--grid-dot),var(--grid-dot)) border-box;
  color: var(--text-color);
  font-family: 'Nunito', sans-serif;
  font-size: 0.95rem; font-weight: 700; outline: none;
  transition: all 0.25s;
  -webkit-appearance: none; appearance: none;
}
.field-input:focus {
  background: linear-gradient(var(--input-bg),var(--input-bg)) padding-box,
              linear-gradient(135deg,#667eea,#764ba2) border-box;
  box-shadow: 0 4px 18px rgba(102,126,234,0.18);
}
.field-input::placeholder { color: var(--empty-text); font-weight: 600; }
select.field-input {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23a0aec0' stroke-width='3'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 14px center;
  padding-right: 36px; cursor: pointer; background-color: var(--input-bg);
}
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

/* ===================================================
   VACCINE SELECTOR
   =================================================== */
.vac-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin: 12px 0; }
.vac-card {
  padding: 12px 14px; border-radius: 14px;
  border: 2px solid var(--border-light); background: var(--surface);
  cursor: pointer; transition: all 0.22s;
  display: flex; flex-direction: column; gap: 6px;
  user-select: none;
}
.vac-card:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(102,126,234,0.12); }
.vac-card:active { transform: scale(0.96); }
.vac-card.selected {
  border-color: #059669; background: rgba(5,150,105,0.08);
  box-shadow: 0 4px 14px rgba(5,150,105,0.15);
}
.vac-card-top { display: flex; align-items: center; gap: 10px; }
.vac-emoji { font-size: 1.6rem; flex-shrink: 0; }
.vac-info { flex: 1; min-width: 0; }
.vac-name { font-weight: 800; font-size: 0.92rem; line-height: 1.2; }
.vac-meta { font-size: 0.65rem; font-weight: 700; color: var(--empty-text); text-transform: uppercase; letter-spacing: 0.8px; margin-top: 2px; }
.vac-check {
  width: 22px; height: 22px; border-radius: 50%;
  border: 2.5px solid var(--grid-dot);
  display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem; flex-shrink: 0; transition: all 0.2s; color: transparent;
}
.vac-card.selected .vac-check { background: #059669; border-color: #059669; color: white; }

/* Lote selector debajo de cada vacuna */
.vac-lot-row {
  display: none;
  margin-top: 2px;
}
.vac-card.selected .vac-lot-row { display: block; }
.vac-lot-select {
  width: 100%; padding: 5px 10px;
  border-radius: 9px; border: 1.5px solid rgba(5,150,105,0.3);
  background: rgba(5,150,105,0.06); color: var(--text-color);
  font-family: 'Nunito', sans-serif; font-size: 0.72rem; font-weight: 700;
  outline: none; cursor: pointer;
  -webkit-appearance: none; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23059669' stroke-width='3'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 8px center;
  padding-right: 24px; background-color: rgba(5,150,105,0.06);
}
.vac-lot-label { font-size: 0.62rem; font-weight: 800; color: var(--green); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 3px; }

/* ===================================================
   BUTTONS
   =================================================== */
.btn {
  padding: 11px 26px; border-radius: 30px; border: none;
  font-family: 'Nunito', sans-serif; font-size: 0.9rem; font-weight: 800;
  cursor: pointer; transition: all 0.2s; outline: none;
  display: inline-flex; align-items: center; gap: 8px;
}
.btn:active { transform: scale(0.95); }
.btn-primary {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white; box-shadow: 0 6px 20px rgba(118,75,162,0.35);
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 26px rgba(118,75,162,0.42); }
.btn-green { background: linear-gradient(135deg, #059669, #047857); color: white; box-shadow: 0 6px 18px rgba(5,150,105,0.3); }
.btn-green:hover { transform: translateY(-2px); }
.btn-orange { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; box-shadow: 0 6px 18px rgba(245,158,11,0.3); }
.btn-red { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; box-shadow: 0 4px 14px rgba(239,68,68,0.3); }
.btn-ghost { background: var(--surface); color: var(--text-color); border: 1.5px solid var(--border-light); }
.btn-ghost:hover { transform: translateY(-2px); box-shadow: 0 5px 14px rgba(0,0,0,0.08); }
.btn-sm { padding: 6px 14px; font-size: 0.78rem; border-radius: 20px; }
.btn-full { width: 100%; justify-content: center; }

/* ===================================================
   ALERT / BADGE
   =================================================== */
.age-badge {
  background: linear-gradient(135deg,#667eea18,#764ba218);
  border: 1px solid var(--accent-color);
  border-radius: 12px; padding: 9px 14px;
  font-size: 0.82rem; font-weight: 700; color: var(--accent-color);
  display: none; margin-top: 8px;
}
.stock-badge {
  display: inline-block; padding: 3px 10px; border-radius: 20px;
  font-size: 0.7rem; font-weight: 800; text-transform: uppercase;
}
.stock-ok   { background: rgba(5,150,105,0.12); color: var(--green); }
.stock-warn { background: rgba(245,158,11,0.12); color: var(--orange); }
.stock-out  { background: rgba(220,38,38,0.12);  color: var(--red); }

/* ===================================================
   PATIENT RECORD CARD ‚Äî sticky note
   =================================================== */
.patient-card {
  padding: 14px 14px 10px; border-radius: 6px;
  box-shadow: 2px 5px 14px rgba(0,0,0,0.09);
  font-family: 'Nunito', sans-serif; font-size: 0.9rem;
  position: relative; transition: transform 0.2s, box-shadow 0.2s;
  margin-bottom: 10px;
}
.patient-card:hover { transform: translateY(-3px); box-shadow: 5px 10px 24px rgba(0,0,0,0.13); }
.patient-card::before {
  content: ''; position: absolute; top: -10px; left: 50%;
  transform: translateX(-50%) rotate(-1deg);
  width: 70px; height: 22px;
  background: var(--tape-color); box-shadow: 0 1px 4px rgba(0,0,0,0.07);
  z-index: 1; pointer-events: none; backdrop-filter: blur(3px);
}
.pc-name { font-weight: 900; font-size: 1rem; color: #1a202c; margin-bottom: 3px; }
.dark-mode .pc-name { color: #f7fafc; }
.pc-meta { font-size: 0.7rem; font-weight: 700; color: #718096; margin-bottom: 8px; }
.pc-tags { display: flex; flex-wrap: wrap; gap: 5px; }
.pc-tag {
  font-size: 0.65rem; font-weight: 800; padding: 3px 9px;
  border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px;
}
.icon-btn {
  background: rgba(255,255,255,0.65); border: none;
  width: 30px; height: 30px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.07);
  transition: transform 0.2s, box-shadow 0.2s;
}
.icon-btn:hover { transform: scale(1.2); box-shadow: 0 4px 10px rgba(0,0,0,0.12); }
.icon-btn:active { transform: scale(0.9); }

.bg-yellow { background: #fef3c7; }
.bg-blue   { background: #bfdbfe; }
.bg-green  { background: #bbf7d0; }
.bg-pink   { background: #fbcfe8; }
.bg-purple { background: #e9d5ff; }
.bg-orange { background: #ffedd5; }
.bg-cyan   { background: #ccfbf1; }

/* ===================================================
   KARDEX CARDS
   =================================================== */
.kdx-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px,1fr)); gap: 10px; }
.kdx-card {
  background: var(--surface); border: var(--glass-border);
  border-radius: 16px; padding: 14px 12px;
  text-align: center; cursor: pointer; transition: all 0.22s;
  box-shadow: var(--shadow-soft); position: relative; overflow: hidden;
}
.kdx-card::after {
  content: ''; position: absolute; inset: 0;
  border-radius: 16px; opacity: 0; transition: opacity 0.2s;
  background: linear-gradient(135deg,rgba(102,126,234,0.08),rgba(118,75,162,0.08));
}
.kdx-card:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.1); }
.kdx-card:hover::after { opacity: 1; }
.kdx-card:active { transform: scale(0.96); }
.kdx-card.danger { border-color: rgba(220,38,38,0.4); background: rgba(220,38,38,0.06); }
.kdx-card.warn   { border-color: rgba(245,158,11,0.4); background: rgba(245,158,11,0.06); }
.kdx-name { font-size: 0.68rem; font-weight: 800; color: var(--empty-text); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; line-height: 1.2; }
.kdx-saldo { font-family: 'Indie Flower', cursive; font-size: 2.4rem; font-weight: 700; line-height: 1; }
.kdx-card.danger .kdx-saldo { color: var(--red); }
.kdx-card.warn   .kdx-saldo { color: var(--orange); }
.kdx-mini { font-size: 0.6rem; font-weight: 700; color: var(--empty-text); margin-top: 6px; display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; }
.kdx-mini span { background: var(--bg-color); border-radius: 6px; padding: 2px 5px; }

/* Lotes debajo del mini en la tarjeta */
.kdx-lots {
  margin-top: 7px; padding-top: 7px;
  border-top: 1px solid var(--border-light);
  text-align: left;
}
.kdx-lot-row {
  font-size: 0.58rem; font-weight: 700; color: var(--empty-text);
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 2px; gap: 4px;
}
.kdx-lot-row .lot-num { font-weight: 900; color: var(--text-color); }
.kdx-lot-row .lot-exp { white-space: nowrap; }
.lot-expiring { color: var(--orange) !important; }
.lot-expired  { color: var(--red) !important; }

/* ===================================================
   MOVEMENT LOG TABLE
   =================================================== */
.mov-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
.mov-table th {
  text-align: left; padding: 8px 12px;
  font-size: 0.65rem; font-weight: 800; text-transform: uppercase;
  letter-spacing: 1px; color: var(--empty-text);
  border-bottom: 2px solid var(--border-light);
}
.mov-table td { padding: 9px 12px; border-bottom: 1px solid var(--border-light); font-weight: 600; }
.mov-table tr:last-child td { border-bottom: none; }
.mov-table tr:hover td { background: rgba(102,126,234,0.04); }
.mov-type { padding: 3px 10px; border-radius: 20px; font-size: 0.68rem; font-weight: 800; text-transform: uppercase; }
.mov-ingreso    { background: rgba(5,150,105,0.12);  color: var(--green); }
.mov-perdida    { background: rgba(220,38,38,0.12);  color: var(--red); }
.mov-devolucion { background: rgba(37,99,235,0.12);  color: var(--blue); }
.mov-traspaso   { background: rgba(124,58,237,0.12); color: var(--purple); }
.mov-egreso     { background: rgba(124,58,237,0.12); color: var(--purple); }

/* ===================================================
   STATS CARDS
   =================================================== */
.stats-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px,1fr)); gap: 10px; margin-bottom: 16px; }
.stat-card {
  background: var(--surface); border: var(--glass-border);
  border-radius: 16px; padding: 14px 16px;
  box-shadow: var(--shadow-soft); text-align: center;
}
.stat-num { font-family: 'Indie Flower', cursive; font-size: 2.2rem; line-height: 1; }
.stat-label { font-size: 0.65rem; font-weight: 800; color: var(--empty-text); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }

/* ===================================================
   FILTROS
   =================================================== */
.filter-bar { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; margin-bottom: 14px; }
.filter-btn {
  padding: 5px 14px; border-radius: 20px;
  border: 1.5px solid var(--border-light);
  background: var(--surface); color: var(--text-color);
  cursor: pointer; font-family: 'Nunito', sans-serif;
  font-size: 0.78rem; font-weight: 800; transition: all 0.2s;
}
.filter-btn:hover { transform: translateY(-1px); }
.filter-btn.active {
  background: linear-gradient(135deg,#667eea,#764ba2);
  color: white; border-color: transparent;
  box-shadow: 0 4px 14px rgba(118,75,162,0.3);
}

/* ===================================================
   EXPORT CARD
   =================================================== */
.export-card {
  background: var(--surface); border: var(--glass-border);
  border-radius: 16px; padding: 16px 18px;
  display: flex; align-items: center; gap: 14px;
  cursor: pointer; transition: all 0.22s; box-shadow: var(--shadow-soft);
  margin-bottom: 10px;
}
.export-card:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(0,0,0,0.1); }
.export-card:active { transform: scale(0.97); }
.export-icon { font-size: 2rem; flex-shrink: 0; }
.export-info { flex: 1; }
.export-title { font-weight: 800; font-size: 0.95rem; }
.export-sub { font-size: 0.72rem; font-weight: 600; color: var(--empty-text); margin-top: 2px; }

/* ===================================================
   MODAL
   =================================================== */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.5); backdrop-filter: blur(6px);
  display: flex; justify-content: center; align-items: flex-end;
  opacity: 0; pointer-events: none; transition: opacity 0.3s;
  z-index: 1000; padding: 0;
}
.modal-overlay.show { opacity: 1; pointer-events: all; }
.modal-content {
  background: var(--modal-bg);
  border-radius: 26px 26px 0 0; padding: 24px 22px;
  width: 100%; max-width: 520px; margin: 0 auto;
  max-height: 92vh; overflow-y: auto;
  box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
  transform: translateY(60px); opacity: 0;
  transition: transform 0.36s cubic-bezier(0.34,1.56,0.64,1), opacity 0.3s;
}
.modal-overlay.show .modal-content { transform: translateY(0); opacity: 1; }
.modal-handle { width: 44px; height: 5px; background: var(--grid-dot); border-radius: 4px; margin: 0 auto 20px; }
.modal-title {
  font-family: 'Indie Flower', cursive;
  font-size: 1.8rem; color: var(--accent-color); text-align: center; margin-bottom: 18px;
}

/* ===================================================
   SECTION DIVIDER
   =================================================== */
.section-divider {
  display: flex; align-items: center; gap: 10px;
  font-size: 0.68rem; font-weight: 800; text-transform: uppercase;
  letter-spacing: 1.5px; color: var(--empty-text);
  margin: 18px 0 12px;
}
.section-divider::before, .section-divider::after {
  content: ''; flex: 1; height: 1px; background: var(--border-light);
}

/* ===================================================
   TOAST
   =================================================== */
.toast {
  position: fixed; bottom: 28px; left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: rgba(30,41,59,0.96); color: white;
  padding: 12px 26px; border-radius: 30px;
  opacity: 0; transition: all 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
  pointer-events: none; z-index: 3000;
  font-weight: 700; font-size: 0.88rem;
  box-shadow: 0 8px 24px rgba(0,0,0,0.25);
  backdrop-filter: blur(10px); max-width: 90%;
  text-align: center; white-space: nowrap;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ===================================================
   STOCK ALERT BARS (Kardex tab)
   =================================================== */
.stock-alert-bar {
  border-radius: 12px; padding: 10px 16px; margin-bottom: 14px;
  font-size: 0.82rem; font-weight: 700;
  display: none; animation: fadeSlideUp 0.3s ease;
}
.stock-alert-bar.stock-type { background: rgba(220,38,38,0.1); border: 1px solid rgba(220,38,38,0.3); color: var(--red); }
.stock-alert-bar.expiry-type { background: rgba(217,119,6,0.1); border: 1px solid rgba(217,119,6,0.35); color: var(--orange); }

/* ===================================================
   CLOSE MONTH SECTION
   =================================================== */
.close-month-card {
  background: linear-gradient(135deg,rgba(102,126,234,0.08),rgba(118,75,162,0.08));
  border: var(--glass-border); border-radius: 18px; padding: 18px;
  box-shadow: var(--shadow-soft); margin-top: 16px;
}

/* ===================================================
   ESQUEMA PENDIENTE
   =================================================== */
.pending-card {
  background: var(--surface); border: var(--glass-border);
  border-radius: 14px; padding: 12px 16px; margin-bottom: 8px;
  display: flex; align-items: center; justify-content: space-between; gap: 10px;
  box-shadow: var(--shadow-soft);
}
.pending-name { font-weight: 800; font-size: 0.92rem; }
.pending-info { font-size: 0.7rem; font-weight: 600; color: var(--empty-text); margin-top: 2px; }
.pending-chips { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
.pending-chip {
  font-size: 0.6rem; font-weight: 800; padding: 2px 8px;
  border-radius: 10px; background: rgba(245,158,11,0.15); color: var(--orange);
}

/* ===================================================
   EMPTY STATE
   =================================================== */
.empty-state {
  text-align: center; padding: 40px 20px;
  font-family: 'Indie Flower', cursive;
  font-size: 1.1rem; color: var(--empty-text);
  animation: fadeSlideUp 0.4s ease;
}
.empty-state .empty-icon { font-size: 3rem; margin-bottom: 10px; }

/* ===================================================
   RESPONSIVE
   =================================================== */
@media (max-width: 640px) {
  header { grid-template-columns: 1fr auto; gap: 6px; padding: 8px 12px; }
  .header-center { display: none; }
  .logo { font-size: 1.6rem; }
  .tabs-nav { gap: 5px; padding: 10px 12px 0; justify-content: center; }
  .tab-btn { padding: 7px 13px; font-size: 0.76rem; }
  .content-area { padding: 12px 12px 90px; }
  .stats-row { grid-template-columns: 1fr 1fr; }
  .kdx-grid  { grid-template-columns: repeat(3,1fr); }
  .grid-2    { grid-template-columns: 1fr; }
  .grid-3    { grid-template-columns: 1fr; }
  .modal-content { padding: 18px 16px; }
  .ctrl-btn { padding: 5px 10px; font-size: 0.75rem; }
  .date-badge { font-size: 0.72rem; padding: 4px 10px; }
}
@media (min-width: 641px) and (max-width: 900px) {
  header { grid-template-columns: auto 1fr auto; }
  .kdx-grid { grid-template-columns: repeat(4,1fr); }
}
@media (min-width: 901px) {
  .tab-panel-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start;
  }
  .tab-panel-grid-3 {
    display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; align-items: start;
  }
  .kdx-grid { grid-template-columns: repeat(5,1fr); }
}

/* ===================================================
   UTILS
   =================================================== */
.hidden { display: none !important; }
.p-4  { padding: 18px; }
.p-5  { padding: 22px; }
.mb-2 { margin-bottom: 8px; }
.mb-3 { margin-bottom: 12px; }
.mb-4 { margin-bottom: 16px; }
.mt-2 { margin-top: 8px; }
.mt-3 { margin-top: 12px; }
.flex { display: flex; }
.flex-wrap { flex-wrap: wrap; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-2 { gap: 8px; }
.gap-3 { gap: 12px; }
.w-full { width: 100%; }
.text-center { text-align: center; }
.font-hand { font-family: 'Indie Flower', cursive; }
.text-accent { color: var(--accent-color); }
.text-sm { font-size: 0.82rem; }
.text-xs { font-size: 0.7rem; }
.font-bold { font-weight: 800; }
.opacity-60 { opacity: 0.6; }
.shake { animation: shake 0.4s ease; }
</style>
</head>

<body>

<!-- HEADER -->
<header>
  <div class="header-left">
    <div class="logo">üíâ VacuFlow <span class="version-tag">ENI</span></div>
  </div>
  <div class="header-center">
    <div id="stock-alert-header" class="alert-bar-stock"></div>
    <div id="expiry-alert-header" class="alert-bar-expiry"></div>
  </div>
  <div class="header-right">
    <span class="date-badge" id="header-date">Hoy</span>
    <button class="ctrl-btn" onclick="toggleTheme()" id="theme-btn">üåô</button>
  </div>
</header>

<!-- TABS -->
<div class="tabs-nav" id="tabs-nav">
  <button class="tab-btn active" onclick="switchTab('vacunar',this)">üíâ Vacunar</button>
  <button class="tab-btn" onclick="switchTab('diario',this)">üìã Parte Diario <span class="tab-badge" id="badge-diario">0</span></button>
  <button class="tab-btn" onclick="switchTab('kardex',this)">üì¶ Kardex</button>
  <button class="tab-btn" onclick="switchTab('pendientes',this)">‚è≥ Pendientes <span class="tab-badge" id="badge-pendientes">0</span></button>
  <button class="tab-btn" onclick="switchTab('reportes',this)">üìä Reportes</button>
</div>

<!-- CONTENT -->
<div class="content-area">

  <!-- ====== TAB: VACUNAR ====== -->
  <div class="tab-panel active" id="tab-vacunar">
    <div class="tab-panel-grid">

      <!-- Columna izquierda: Formulario -->
      <div>
        <div class="glass-card p-5 mb-4">
          <div class="card-header">
            <div class="card-title">‚ú® Registrar Vacunaci√≥n</div>
            <span class="date-badge" id="vac-date-display"></span>
          </div>

          <div class="field-group">
            <label class="field-label">üìÖ Fecha de aplicaci√≥n</label>
            <input type="date" id="p-fecha" class="field-input" onchange="validateFecha()">
            <div id="fecha-warn" style="font-size:0.72rem;font-weight:700;color:var(--orange);margin-top:4px;display:none;">‚ö†Ô∏è No se permiten fechas futuras</div>
          </div>

          <div class="field-group">
            <label class="field-label">üë∂ Nombre completo del paciente</label>
            <input type="text" id="p-name" class="field-input" placeholder="Ej. Juan Carlos P√©rez L√≥pez" autocomplete="off">
          </div>

          <div class="grid-2 mb-3">
            <div class="field-group" style="margin:0">
              <label class="field-label">üéÇ Fecha de nacimiento</label>
              <input type="date" id="p-dob" class="field-input" onchange="calcEsquema()">
            </div>
            <div class="field-group" style="margin:0">
              <label class="field-label">üìå Esquema</label>
              <select id="p-esquema" class="field-input" onchange="renderVaccines()">
                <option value="0">Reci√©n Nacido</option>
                <option value="2">2 Meses</option>
                <option value="4">4 Meses</option>
                <option value="6">6 Meses</option>
                <option value="12">12 Meses</option>
                <option value="15">15 Meses</option>
                <option value="18">18 Meses</option>
              </select>
            </div>
          </div>
          <div id="age-badge" class="age-badge"></div>
        </div>

        <!-- Vacunas -->
        <div class="glass-card p-5">
          <div class="card-header">
            <div class="card-title">üíä Dosis del Esquema</div>
            <span id="sel-count" style="font-size:0.78rem;font-weight:800;color:var(--accent-color)">0 selec.</span>
          </div>
          <div class="vac-grid" id="vaccine-selector"></div>
          <div class="mt-3">
            <button class="btn btn-primary btn-full" onclick="saveRecord()">
              üíæ Registrar y Descontar Stock
            </button>
          </div>
        </div>
      </div>

      <!-- Columna derecha: Resumen -->
      <div>
        <div class="glass-card p-5">
          <div class="card-header">
            <div class="card-title">üìä Resumen Hoy</div>
            <div id="quick-date" style="font-size:0.75rem;font-weight:700;color:var(--empty-text)"></div>
          </div>
          <div class="stats-row" id="quick-stats"></div>
          <div class="section-divider">√∫ltimas vacunaciones</div>
          <div id="quick-list" style="max-height:320px;overflow-y:auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== TAB: DIARIO ====== -->
  <div class="tab-panel" id="tab-diario">
    <div class="glass-card p-5 mb-4">
      <div class="card-header">
        <div class="card-title">üìã Parte Diario</div>
        <input type="text" id="search-input" class="field-input" style="width:180px;padding:7px 14px;font-size:0.82rem;" placeholder="üîç Buscar paciente..." oninput="renderDiario()">
      </div>
      <div class="filter-bar" id="diario-filter-bar">
        <button class="filter-btn active" onclick="setFilter('hoy',this)">üìÖ Hoy</button>
        <button class="filter-btn" onclick="setFilter('semana',this)">üìÜ Esta semana</button>
        <button class="filter-btn" onclick="setFilter('mes',this)">üóìÔ∏è Este mes</button>
        <button class="filter-btn" onclick="setFilter('todo',this)">üìÇ Todo</button>
        <input type="date" id="filter-date" class="field-input" style="width:150px;padding:6px 12px;font-size:0.8rem;" onchange="setFilter('fecha',null)" title="Fecha espec√≠fica">
      </div>
      <div class="stats-row" id="diario-stats"></div>
      <div id="patient-list"></div>
      <div id="empty-diario" class="empty-state hidden">
        <div class="empty-icon">üóíÔ∏è</div><div>Sin registros para este per√≠odo</div>
      </div>
    </div>
  </div>

  <!-- ====== TAB: KARDEX ====== -->
  <div class="tab-panel" id="tab-kardex">
    <div id="stock-alert-kardex" class="stock-alert-bar stock-type"></div>
    <div id="expiry-alert-kardex" class="stock-alert-bar expiry-type"></div>

    <div class="tab-panel-grid">
      <div>
        <div class="glass-card p-5 mb-4">
          <div class="card-header">
            <div class="card-title">üß™ Biol√≥gicos</div>
            <button class="btn btn-primary btn-sm" onclick="openMovModal('bio',null)">+ Registrar movimiento</button>
          </div>
          <div class="kdx-grid" id="inv-biologicos"></div>
        </div>
        <div class="glass-card p-5">
          <div class="card-header">
            <div class="card-title">üíâ Jeringas</div>
            <button class="btn btn-primary btn-sm" onclick="openMovModal('jer',null)">+ Registrar movimiento</button>
          </div>
          <div class="kdx-grid" id="inv-jeringas"></div>
          <p style="font-size:0.68rem;color:var(--empty-text);text-align:center;margin-top:10px;font-weight:700;">Toca una tarjeta para ver el detalle y registrar movimientos</p>
        </div>
      </div>

      <div>
        <div class="glass-card p-5">
          <div class="card-header">
            <div class="card-title">üìú Historial de Movimientos</div>
          </div>
          <div class="filter-bar" id="kardex-filter-bar">
            <button class="filter-btn active" onclick="setMovFilter('hoy',this)">Hoy</button>
            <button class="filter-btn" onclick="setMovFilter('semana',this)">Semana</button>
            <button class="filter-btn" onclick="setMovFilter('mes',this)">Mes</button>
            <button class="filter-btn" onclick="setMovFilter('todo',this)">Todo</button>
          </div>
          <div style="overflow-x:auto;">
            <table class="mov-table">
              <thead><tr>
                <th>Fecha</th><th>Biol√≥gico/Insumo</th><th>Tipo</th><th>Cant.</th><th>Lote</th><th>Nota</th><th></th>
              </tr></thead>
              <tbody id="mov-tbody"></tbody>
            </table>
          </div>
          <div id="empty-movs" class="empty-state hidden">
            <div class="empty-icon">üì¶</div><div>Sin movimientos en este per√≠odo</div>
          </div>
        </div>

        <div class="close-month-card">
          <div style="font-family:'Indie Flower',cursive;font-size:1.3rem;color:var(--accent-color);margin-bottom:8px;">üîí Cierre de Mes</div>
          <p style="font-size:0.82rem;font-weight:600;color:var(--text-color);opacity:0.8;margin-bottom:12px;">
            Congela los n√∫meros actuales y prepara el Kardex para el nuevo mes. El historial de pacientes se conserva siempre.
          </p>
          <button class="btn btn-orange btn-full" onclick="closeMonth()">üîí Cerrar mes y reiniciar Kardex</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== TAB: PENDIENTES ====== -->
  <div class="tab-panel" id="tab-pendientes">
    <div class="glass-card p-5">
      <div class="card-header">
        <div class="card-title">‚è≥ Esquemas Pendientes</div>
        <span id="pend-counter" style="font-size:0.78rem;font-weight:800;color:var(--accent-color)"></span>
      </div>

      <!-- Buscador -->
      <div style="margin-bottom:14px;">
        <input type="text" id="pend-search" class="field-input"
          style="padding:8px 16px;font-size:0.88rem;"
          placeholder="üîç Buscar ni√±o..." oninput="renderPendientes()">
      </div>

      <!-- Leyenda sem√°foro -->
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;">
        <span style="font-size:0.7rem;font-weight:800;color:#059669;">üü¢ Hoy</span>
        <span style="font-size:0.7rem;font-weight:800;color:#d97706;">üü° 1‚Äì14 d√≠as de retraso</span>
        <span style="font-size:0.7rem;font-weight:800;color:#dc2626;">üî¥ M√°s de 14 d√≠as</span>
      </div>

      <div id="pendientes-list"></div>
      <div id="empty-pendientes" class="empty-state hidden">
        <div class="empty-icon">‚úÖ</div><div>¬°Todos los esquemas est√°n al d√≠a!</div>
      </div>
    </div>
  </div>

  <!-- ====== TAB: REPORTES ====== -->
  <div class="tab-panel" id="tab-reportes">
    <div class="tab-panel-grid">
      <div>
        <div class="glass-card p-5 mb-4">
          <div class="card-header">
            <div class="card-title">üìä Resumen del Mes</div>
          </div>
          <div class="stats-row" id="report-stats"></div>
        </div>
        <div class="glass-card p-5">
          <div class="card-title mb-3">üì§ Exportar a Excel</div>
          <p style="font-size:0.8rem;font-weight:600;color:var(--empty-text);margin-bottom:14px;">Archivos listos para tu matriz MSP.</p>

          <div class="export-card" onclick="exportPatients()">
            <div class="export-icon">üë∂</div>
            <div class="export-info">
              <div class="export-title">Pacientes Vacunados</div>
              <div class="export-sub">Registro mensual con fechas, esquemas y dosis ¬∑ .xlsx</div>
            </div>
            <span style="font-size:1.2rem;">‚Üí</span>
          </div>
          <div class="export-card" onclick="exportKardex()">
            <div class="export-icon">üß™</div>
            <div class="export-info">
              <div class="export-title">Kardex de Biol√≥gicos</div>
              <div class="export-sub">Ingresos, egresos, p√©rdidas y saldos ¬∑ .xlsx</div>
            </div>
            <span style="font-size:1.2rem;">‚Üí</span>
          </div>
          <div class="export-card" onclick="exportJeringas()">
            <div class="export-icon">üíâ</div>
            <div class="export-info">
              <div class="export-title">Control de Jeringas</div>
              <div class="export-sub">Movimiento mensual de jeringas ¬∑ .xlsx</div>
            </div>
            <span style="font-size:1.2rem;">‚Üí</span>
          </div>
          <div class="export-card" onclick="exportMovimientos()">
            <div class="export-icon">üìú</div>
            <div class="export-info">
              <div class="export-title">Historial de Movimientos</div>
              <div class="export-sub">Ingresos, p√©rdidas y devoluciones con lote ¬∑ .xlsx</div>
            </div>
            <span style="font-size:1.2rem;">‚Üí</span>
          </div>
          <div class="export-card" onclick="exportCompleto()" style="border:2px solid var(--accent-color);">
            <div class="export-icon">üóÇÔ∏è</div>
            <div class="export-info">
              <div class="export-title" style="color:var(--accent-color);">Reporte Completo MSP</div>
              <div class="export-sub">5 hojas + Registro Personal ¬∑ formato MSP ¬∑ .xlsx</div>
            </div>
            <span style="font-size:1.2rem;color:var(--accent-color);">‚Üí</span>
          </div>
        </div>
      </div>

      <div>
        <div class="glass-card p-5">
          <div class="card-title mb-3">üóÑÔ∏è Gesti√≥n de Datos</div>
          <p style="font-size:0.8rem;font-weight:600;color:var(--empty-text);margin-bottom:16px;">
            Todos tus datos se guardan localmente en este dispositivo. Funcionan sin internet. Exporta para hacer copias de seguridad.
          </p>
          <div style="background:rgba(102,126,234,0.08);border-radius:14px;padding:14px;margin-bottom:14px;">
            <div style="font-size:0.75rem;font-weight:800;color:var(--accent-color);margin-bottom:6px;">‚ÑπÔ∏è ALMACENAMIENTO LOCAL</div>
            <div id="storage-info" style="font-size:0.8rem;font-weight:600;opacity:0.8;"></div>
          </div>
          <button class="btn btn-red btn-full" onclick="clearAllData()" style="margin-top:8px;">üóëÔ∏è Limpiar todos los datos</button>
        </div>
      </div>
    </div>
  </div>

</div><!-- /content-area -->

<!-- MODAL: MOVIMIENTO -->
<div class="modal-overlay" id="modal-mov">
  <div class="modal-content">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-mov-title">Registrar Movimiento</div>

    <div class="field-group">
      <label class="field-label">üìÖ Fecha del movimiento</label>
      <input type="date" id="mov-fecha" class="field-input" onchange="validateMovFecha()">
      <div id="mov-fecha-warn" style="font-size:0.72rem;font-weight:700;color:var(--orange);margin-top:4px;display:none;">‚ö†Ô∏è No se permiten fechas futuras</div>
    </div>

    <div class="field-group" id="mov-bio-group">
      <label class="field-label">üß™ Biol√≥gico</label>
      <select id="mov-item" class="field-input" onchange="onMovItemChange()"></select>
    </div>

    <div class="field-group">
      <label class="field-label">üìå Tipo de movimiento</label>
      <select id="mov-tipo" class="field-input" onchange="toggleMovFields()">
        <option value="ingreso">üì• Ingreso ‚Äî Recibido del Distrito</option>
        <option value="traspaso">üîÑ Traspaso ‚Äî Recibido de otro Centro de Salud</option>
        <option value="perdida">‚ö†Ô∏è P√©rdida / Descarte</option>
        <option value="devolucion">üì§ Devoluci√≥n al Distrito</option>
      </select>
    </div>

    <div class="field-group">
      <label class="field-label">üî¢ Cantidad</label>
      <input type="number" id="mov-cantidad" class="field-input" placeholder="0" min="1" inputmode="numeric">
    </div>

    <!-- Campos SOLO para ingreso: lote + vencimiento -->
    <div id="ingreso-fields">
      <div class="grid-2">
        <div class="field-group" style="margin:0">
          <label class="field-label">üè∑Ô∏è N¬∞ de Lote (opcional)</label>
          <input type="text" id="mov-lote" class="field-input" placeholder="Ej. L12, ABC-2026" style="text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()">
        </div>
        <div class="field-group" style="margin:0">
          <label class="field-label">üìÜ Fecha de expiraci√≥n</label>
          <input type="date" id="mov-expiry" class="field-input">
        </div>
      </div>
    </div>

    <!-- Campo: seleccionar lote para p√©rdida/devoluci√≥n -->
    <div class="field-group" id="lot-select-group" style="display:none;">
      <label class="field-label">üè∑Ô∏è Descontar del lote</label>
      <select id="mov-lot-sel" class="field-input">
        <option value="">Sin especificar lote</option>
      </select>
    </div>

    <div class="field-group" id="causa-group">
      <label class="field-label">üìù Causa (obligatorio para p√©rdidas)</label>
      <select id="mov-causa" class="field-input">
        <option value="">Seleccionar causa...</option>
        <option value="Frasco abierto no usado">Frasco abierto no usado</option>
        <option value="Vencimiento">Vencimiento</option>
        <option value="Rotura / accidente">Rotura / accidente</option>
        <option value="Fallo cadena de fr√≠o">Fallo cadena de fr√≠o</option>
        <option value="Otra causa">Otra causa</option>
      </select>
    </div>

    <div class="field-group">
      <label class="field-label">üìÑ Observaciones (opcional)</label>
      <input type="text" id="mov-obs" class="field-input" placeholder="Ej. Recibido de bodega Distrito 08">
    </div>

    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-ghost btn-full" onclick="closeModal('modal-mov')">Cancelar</button>
      <button class="btn btn-primary btn-full" onclick="saveMovimiento()">üíæ Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL: DETALLE KARDEX -->
<div class="modal-overlay" id="modal-kdx-detail">
  <div class="modal-content">
    <div class="modal-handle"></div>
    <div class="modal-title" id="kdx-detail-title">Detalle</div>
    <div id="kdx-detail-body"></div>
    <div style="display:flex;gap:10px;margin-top:16px;">
      <button class="btn btn-ghost btn-full" onclick="closeModal('modal-kdx-detail')">Cerrar</button>
      <button class="btn btn-primary btn-full" id="kdx-mov-btn">+ Movimiento</button>
    </div>
  </div>
</div>

<!-- MODAL: EDITAR MOVIMIENTO -->
<div class="modal-overlay" id="modal-edit-mov">
  <div class="modal-content">
    <div class="modal-handle"></div>
    <div class="modal-title">‚úèÔ∏è Editar Movimiento</div>

    <div class="field-group">
      <label class="field-label">üìÖ Fecha</label>
      <input type="date" id="edit-fecha" class="field-input">
    </div>
    <div class="field-group">
      <label class="field-label">üìå Tipo de movimiento</label>
      <select id="edit-tipo" class="field-input" onchange="toggleEditCausa()">
        <option value="ingreso">üì• Ingreso ‚Äî Recibido del Distrito</option>
        <option value="traspaso">üîÑ Traspaso ‚Äî Recibido de otro Centro de Salud</option>
        <option value="perdida">‚ö†Ô∏è P√©rdida / Descarte</option>
        <option value="devolucion">üì§ Devoluci√≥n al Distrito</option>
      </select>
    </div>
    <div class="field-group">
      <label class="field-label">üî¢ Cantidad</label>
      <input type="number" id="edit-cantidad" class="field-input" min="1" inputmode="numeric">
    </div>
    <div class="field-group">
      <label class="field-label">üè∑Ô∏è N¬∞ de Lote</label>
      <input type="text" id="edit-lote" class="field-input" placeholder="Ej. L12" style="text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()">
    </div>
    <div class="field-group" id="edit-causa-group">
      <label class="field-label">üìù Causa (p√©rdidas)</label>
      <select id="edit-causa" class="field-input">
        <option value="">Seleccionar causa...</option>
        <option value="Frasco abierto no usado">Frasco abierto no usado</option>
        <option value="Vencimiento">Vencimiento</option>
        <option value="Rotura / accidente">Rotura / accidente</option>
        <option value="Fallo cadena de fr√≠o">Fallo cadena de fr√≠o</option>
        <option value="Otra causa">Otra causa</option>
      </select>
    </div>
    <div class="field-group">
      <label class="field-label">üìÑ Observaciones</label>
      <input type="text" id="edit-obs" class="field-input" placeholder="Observaciones opcionales">
    </div>

    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-ghost btn-full" onclick="closeModal('modal-edit-mov')">Cancelar</button>
      <button class="btn btn-primary btn-full" onclick="saveEditMovimiento()">üíæ Guardar cambios</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===================================================
   BASE DE DATOS MSP
   =================================================== */
const MSP_DB = {
  "0":  [
    { id:'bcg',   name:'BCG',             desc:'ID ¬∑ Intrad√©rmica',  syr:'27G', emoji:'üîµ' },
    { id:'hb',    name:'Hepatitis B',     desc:'IM ¬∑ Pedi√°trica',   syr:'23G', emoji:'üü°' }
  ],
  "2":  [
    { id:'penta', name:'Pentavalente 1',  desc:'IM ¬∑ Intramuscular', syr:'23G', emoji:'üü£' },
    { id:'fipv',  name:'fIPV (Polio) 1', desc:'IM ¬∑ Intramuscular', syr:'23G', emoji:'üîµ' },
    { id:'rota',  name:'Rotavirus 1',     desc:'VO ¬∑ Oral',          syr:'oral',emoji:'üü¢' },
    { id:'neumo', name:'Neumococo 1',     desc:'IM ¬∑ Intramuscular', syr:'23G', emoji:'üî¥' }
  ],
  "4":  [
    { id:'penta', name:'Pentavalente 2',  desc:'IM ¬∑ Intramuscular', syr:'23G', emoji:'üü£' },
    { id:'opv',   name:'bOPV (Polio) 2', desc:'VO ¬∑ Oral',          syr:'oral',emoji:'üîµ' },
    { id:'rota',  name:'Rotavirus 2',     desc:'VO ¬∑ Oral',          syr:'oral',emoji:'üü¢' },
    { id:'neumo', name:'Neumococo 2',     desc:'IM ¬∑ Intramuscular', syr:'23G', emoji:'üî¥' }
  ],
  "6":  [
    { id:'penta', name:'Pentavalente 3',  desc:'IM ¬∑ Intramuscular', syr:'23G', emoji:'üü£' },
    { id:'opv',   name:'bOPV (Polio) 3', desc:'VO ¬∑ Oral',          syr:'oral',emoji:'üîµ' },
    { id:'flu',   name:'Influenza 1',     desc:'IM ¬∑ Intramuscular', syr:'23G', emoji:'üü†' }
  ],
  "12": [
    { id:'srp',   name:'SRP 1',           desc:'SC ¬∑ Subcut√°nea',    syr:'25G', emoji:'üü°' },
    { id:'fa',    name:'Fiebre Amarilla', desc:'SC ¬∑ Subcut√°nea',    syr:'25G', emoji:'üü°' },
    { id:'neumo', name:'Neumo Refuerzo',  desc:'IM ¬∑ Intramuscular', syr:'23G', emoji:'üî¥' }
  ],
  "15": [
    { id:'vari',  name:'Varicela',        desc:'SC ¬∑ Subcut√°nea',    syr:'25G', emoji:'üü¢' }
  ],
  "18": [
    { id:'dpt',   name:'DPT Refuerzo 1', desc:'IM ¬∑ Intramuscular', syr:'23G', emoji:'üü£' },
    { id:'opv',   name:'bOPV Refuerzo',  desc:'VO ¬∑ Oral',          syr:'oral',emoji:'üîµ' },
    { id:'srp',   name:'SRP 2',           desc:'SC ¬∑ Subcut√°nea',    syr:'25G', emoji:'üü°' }
  ]
};

const NEXT_SCHEMA = { "0":"2","2":"4","4":"6","6":"12","12":"15","15":"18","18":null };

const BIO_NAMES = {
  bcg:'BCG', hb:'Hepatitis B', penta:'Pentavalente', fipv:'fIPV (Polio iny.)',
  opv:'bOPV (Polio oral)', rota:'Rotavirus', neumo:'Neumococo',
  flu:'Influenza', srp:'SRP', fa:'Fiebre Amarilla', vari:'Varicela', dpt:'DPT'
};
const JER_NAMES = { '23G':'Jeringa 23G (IM)', '25G':'Jeringa 25G (SC)', '27G':'Jeringa 27G (ID)' };
const STICKY_COLORS = ['bg-yellow','bg-blue','bg-green','bg-pink','bg-purple','bg-orange','bg-cyan'];

/* ===================================================
   ESTADO GLOBAL
   =================================================== */
let selectedVaccines = new Set();
let currentMovType   = 'bio';
let currentKdxKey    = null;
let currentKdxType   = 'bio';
let currentFilter    = 'hoy';
let currentMovFilter = 'mes';

const mkEmpty = () => ({ ing:0, apl:0, per:0, dev:0 });

let records   = JSON.parse(localStorage.getItem('vf2_records'))   || [];
let movements = JSON.parse(localStorage.getItem('vf2_movements')) || [];

let inventory = JSON.parse(localStorage.getItem('vf2_inventory')) || {
  bio: { bcg:mkEmpty(),hb:mkEmpty(),penta:mkEmpty(),fipv:mkEmpty(),opv:mkEmpty(),
         rota:mkEmpty(),neumo:mkEmpty(),flu:mkEmpty(),srp:mkEmpty(),fa:mkEmpty(),
         vari:mkEmpty(),dpt:mkEmpty() },
  jer: { '23G':mkEmpty(),'25G':mkEmpty(),'27G':mkEmpty() }
};

// Lotes: { bio: { bcg: [{id, lote, expiry, qty}], ... }, jer: {...} }
let lots = JSON.parse(localStorage.getItem('vf2_lots')) || {
  bio: { bcg:[],hb:[],penta:[],fipv:[],opv:[],rota:[],neumo:[],flu:[],srp:[],fa:[],vari:[],dpt:[] },
  jer: { '23G':[],'25G':[],'27G':[] }
};

/* ===================================================
   INIT
   =================================================== */
function initApp() {
  const savedTheme = localStorage.getItem('vf2_theme');
  if (savedTheme === 'dark') { document.body.classList.add('dark-mode'); document.getElementById('theme-btn').textContent = '‚òÄÔ∏è'; }

  const today = todayStr();
  document.getElementById('header-date').textContent    = fmtDate(today);
  document.getElementById('vac-date-display').textContent = fmtDate(today);
  document.getElementById('p-fecha').value  = today;
  document.getElementById('p-fecha').max    = today;
  document.getElementById('mov-fecha').value = today;
  document.getElementById('mov-fecha').max   = today;
  document.getElementById('filter-date').max = today;
  document.getElementById('quick-date').textContent = fmtDate(today);

  renderVaccines();
  renderQuickStats();
  renderQuickList();
  renderBadgeDiario();
  renderBadgePendientes();
  checkStockAlert();
  renderStorageInfo();
}

/* ===================================================
   HELPERS
   =================================================== */
function todayStr() { return new Date().toISOString().split('T')[0]; }

function fmtDate(str) {
  if (!str) return '';
  const [y,m,d] = str.split('-');
  const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  return `${d} ${months[parseInt(m)-1]} ${y}`;
}

function calcSaldo(item) { return (item.ing||0)-(item.apl||0)-(item.per||0)-(item.dev||0); }
function getMonthStr() { return new Date().toISOString().substring(0,7); }
function stickyColor(i) { return STICKY_COLORS[i % STICKY_COLORS.length]; }

function getWeekRange() {
  const now = new Date(), day = now.getDay() || 7;
  const mon = new Date(now); mon.setDate(now.getDate()-day+1);
  const sun = new Date(mon); sun.setDate(mon.getDate()+6);
  return { start: mon.toISOString().split('T')[0], end: sun.toISOString().split('T')[0] };
}

function filterRecords(f, dateVal) {
  const today = todayStr(), month = getMonthStr(), week = getWeekRange();
  return records.filter(r => {
    if (f==='hoy')    return r.dateApplied === today;
    if (f==='semana') return r.dateApplied >= week.start && r.dateApplied <= week.end;
    if (f==='mes')    return r.dateApplied.startsWith(month);
    if (f==='fecha')  return r.dateApplied === dateVal;
    return true;
  });
}

function filterMovements(f) {
  const today = todayStr(), month = getMonthStr(), week = getWeekRange();
  return movements.filter(m => {
    if (f==='hoy')    return m.fecha === today;
    if (f==='semana') return m.fecha >= week.start && m.fecha <= week.end;
    if (f==='mes')    return m.fecha.startsWith(month);
    return true;
  });
}

function saveAll() {
  localStorage.setItem('vf2_records',   JSON.stringify(records));
  localStorage.setItem('vf2_movements', JSON.stringify(movements));
  localStorage.setItem('vf2_inventory', JSON.stringify(inventory));
  localStorage.setItem('vf2_lots',      JSON.stringify(lots));
}

/* ===================================================
   LOTES ‚Äî helpers
   =================================================== */
function getActiveLots(type, key) {
  if (!lots[type] || !lots[type][key]) return [];
  return lots[type][key].filter(l => l.qty > 0);
}

// Retorna true si un lote vence en <= 90 d√≠as
function isExpiringSoon(expiryStr) {
  if (!expiryStr) return false;
  const exp  = new Date(expiryStr + 'T00:00:00');
  const now  = new Date();
  const diff = (exp - now) / (1000 * 60 * 60 * 24);
  return diff >= 0 && diff <= 90;
}

function isExpired(expiryStr) {
  if (!expiryStr) return false;
  return new Date(expiryStr + 'T00:00:00') < new Date();
}

function fmtExpiry(str) {
  if (!str) return '‚Äî';
  const [y,m] = str.split('-');
  return `${m}/${y.substring(2)}`; // MM/YY
}

/* ===================================================
   TEMA
   =================================================== */
function toggleTheme() {
  const dark = document.body.classList.toggle('dark-mode');
  document.getElementById('theme-btn').textContent = dark ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('vf2_theme', dark ? 'dark' : 'light');
}

/* ===================================================
   NAVEGACI√ìN TABS
   =================================================== */
function switchTab(id, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  if (btn) btn.classList.add('active');

  if (id==='diario')     renderDiario();
  if (id==='kardex')     { renderKardex(); renderMovTable(); checkStockAlert(); }
  if (id==='pendientes') renderPendientes();
  if (id==='reportes')   { renderReportStats(); renderStorageInfo(); }
}

/* ===================================================
   FECHA VALIDACI√ìN
   =================================================== */
function validateFecha() {
  const today = todayStr();
  const v = document.getElementById('p-fecha').value;
  if (v > today) {
    document.getElementById('p-fecha').value = today;
    const w = document.getElementById('fecha-warn');
    w.style.display = 'block';
    setTimeout(() => w.style.display = 'none', 3000);
  }
  document.getElementById('vac-date-display').textContent = fmtDate(document.getElementById('p-fecha').value);
}
function validateMovFecha() {
  const today = todayStr();
  const v = document.getElementById('mov-fecha').value;
  if (v > today) {
    document.getElementById('mov-fecha').value = today;
    const w = document.getElementById('mov-fecha-warn');
    w.style.display = 'block';
    setTimeout(() => w.style.display = 'none', 3000);
  }
}

/* ===================================================
   TAB 1: VACUNAR
   =================================================== */
function calcEsquema() {
  const dob = document.getElementById('p-dob').value;
  if (!dob) return;
  const birth = new Date(dob+'T00:00:00'), today = new Date();
  let months = (today.getFullYear()-birth.getFullYear())*12 + (today.getMonth()-birth.getMonth());
  if (today.getDate() < birth.getDate()) months--;
  months = Math.max(0, months);

  let s = '0';
  if      (months>=18) s='18';
  else if (months>=15) s='15';
  else if (months>=12) s='12';
  else if (months>=6)  s='6';
  else if (months>=4)  s='4';
  else if (months>=2)  s='2';

  document.getElementById('p-esquema').value = s;
  const badge = document.getElementById('age-badge');
  badge.textContent = `üìÖ Edad: ${months} mes${months===1?'':'es'} ¬∑ Esquema sugerido: ${s==='0'?'Reci√©n Nacido':s+' meses'}`;
  badge.style.display = 'block';
  renderVaccines();
}

function renderVaccines() {
  const esquema   = document.getElementById('p-esquema').value;
  const container = document.getElementById('vaccine-selector');
  container.innerHTML = '';
  selectedVaccines.clear();
  updateSelCount();

  MSP_DB[esquema].forEach(v => {
    const activeLots = getActiveLots('bio', v.id);

    const div = document.createElement('div');
    div.className = 'vac-card';
    div.dataset.vacId = v.id;
    div.onclick = (e) => {
      // No toggle si click fue en el select de lote
      if (e.target.classList.contains('vac-lot-select')) return;
      toggleVac(v, div);
    };

    // Construir opciones de lote
    let lotOptionsHtml = '';
    if (activeLots.length > 0) {
      lotOptionsHtml = activeLots.map(l => {
        const expLabel = l.expiry ? ` ¬∑ vence ${fmtExpiry(l.expiry)}` : '';
        return `<option value="${l.id}">${l.lote} ‚Äî ${l.qty} dosis${expLabel}</option>`;
      }).join('');
      lotOptionsHtml = `<option value="">Sin especificar lote</option>` + lotOptionsHtml;
    }

    div.innerHTML = `
      <div class="vac-card-top">
        <div class="vac-emoji">${v.emoji}</div>
        <div class="vac-info">
          <div class="vac-name">${v.name}</div>
          <div class="vac-meta">${v.desc}${v.syr!=='oral'?' ¬∑ Jeringa '+v.syr:''}</div>
        </div>
        <div class="vac-check">‚úì</div>
      </div>
      ${activeLots.length > 0 ? `
      <div class="vac-lot-row">
        <div class="vac-lot-label">üì¶ Lote a aplicar</div>
        <select class="vac-lot-select" data-vac-id="${v.id}" onclick="event.stopPropagation()">
          ${lotOptionsHtml}
        </select>
      </div>` : ''}
    `;
    container.appendChild(div);
    toggleVac(v, div); // pre-select all
  });
}

function toggleVac(v, el) {
  if (selectedVaccines.has(v)) {
    selectedVaccines.delete(v); el.classList.remove('selected');
  } else {
    selectedVaccines.add(v); el.classList.add('selected');
  }
  updateSelCount();
}

function updateSelCount() {
  document.getElementById('sel-count').textContent = selectedVaccines.size + ' selec.';
}

function saveRecord() {
  const fecha   = document.getElementById('p-fecha').value;
  const name    = document.getElementById('p-name').value.trim();
  const dob     = document.getElementById('p-dob').value;
  const esquema = document.getElementById('p-esquema').value;

  if (!name) { shakeInput('p-name'); showToast('‚ö†Ô∏è Ingresa el nombre del paciente'); return; }
  if (!dob)  { shakeInput('p-dob');  showToast('‚ö†Ô∏è Ingresa la fecha de nacimiento'); return; }
  if (!fecha){ showToast('‚ö†Ô∏è Selecciona la fecha de aplicaci√≥n'); return; }
  if (selectedVaccines.size===0) { showToast('‚ö†Ô∏è Selecciona al menos una vacuna'); return; }
  if (fecha > todayStr()) { showToast('‚ö†Ô∏è No se permiten fechas futuras'); return; }

  let stockError = '';
  selectedVaccines.forEach(v => {
    if (v.syr!=='oral') {
      const bio = inventory.bio[v.id];
      if (bio && calcSaldo(bio) <= 0) stockError += `\n‚Ä¢ ${v.name} sin stock`;
    }
  });
  if (stockError) {
    if (!confirm(`‚ö†Ô∏è Stock insuficiente en:${stockError}\n\n¬øDeseas registrar de todas formas?`)) return;
  }

  const vacsApplied = [...selectedVaccines];

  // Calcular edad en meses al momento de vacunar
  const birth = new Date(dob+'T00:00:00'), today = new Date();
  let ageMonths = (today.getFullYear()-birth.getFullYear())*12 + (today.getMonth()-birth.getMonth());
  if (today.getDate() < birth.getDate()) ageMonths--;
  ageMonths = Math.max(0, ageMonths);

  // Descontar inventario y lotes
  const appliedVacData = vacsApplied.map(v => {
    // Leer lote seleccionado en el selector de la tarjeta
    const lotSel = document.querySelector(`.vac-lot-select[data-vac-id="${v.id}"]`);
    const lotId  = lotSel ? lotSel.value : '';
    let appliedLote = '';

    if (inventory.bio[v.id])                   inventory.bio[v.id].apl++;
    if (v.syr!=='oral' && inventory.jer[v.syr]) inventory.jer[v.syr].apl++;

    // Descontar del lote si se especific√≥
    if (lotId && lots.bio[v.id]) {
      const lot = lots.bio[v.id].find(l => l.id == lotId);
      if (lot && lot.qty > 0) { lot.qty--; appliedLote = lot.lote; }
    }

    return { id:v.id, name:v.name, desc:v.desc, syr:v.syr, emoji:v.emoji, lote: appliedLote };
  });

  const record = {
    id: Date.now(), dateApplied: fecha,
    name, dob, ageMonths,
    esquemaKey: esquema,
    esquema: esquema==='0' ? 'Reci√©n Nacido' : esquema+' Meses',
    vaccines: appliedVacData,
    color: stickyColor(records.length)
  };
  records.push(record);
  saveAll();

  try { confetti({ particleCount:120, spread:70, origin:{y:0.6}, colors:['#667eea','#764ba2','#10b981','#f59e0b'] }); } catch(e){}

  showToast(`‚úÖ ${name} registrado correctamente`);
  renderQuickStats(); renderQuickList(); renderBadgeDiario(); renderBadgePendientes(); checkStockAlert();

  document.getElementById('p-name').value = '';
  document.getElementById('p-dob').value  = '';
  document.getElementById('age-badge').style.display = 'none';
  document.getElementById('p-fecha').value = todayStr();
  renderVaccines();
}

function renderQuickStats() {
  const today = todayStr(), todayRecs = records.filter(r=>r.dateApplied===today);
  const totalDoses = todayRecs.reduce((a,r)=>a+r.vaccines.length,0);
  const monthRecs  = records.filter(r=>r.dateApplied.startsWith(getMonthStr()));
  document.getElementById('quick-stats').innerHTML = `
    <div class="stat-card"><div class="stat-num" style="color:var(--accent-color)">${todayRecs.length}</div><div class="stat-label">Ni√±os hoy</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--green)">${totalDoses}</div><div class="stat-label">Dosis hoy</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--purple)">${monthRecs.length}</div><div class="stat-label">Ni√±os mes</div></div>`;
}

function renderQuickList() {
  const today    = todayStr();
  const todayRecs = records.filter(r=>r.dateApplied===today).slice().reverse().slice(0,5);
  const el = document.getElementById('quick-list');
  if (!todayRecs.length) {
    el.innerHTML = '<div class="empty-state" style="padding:20px"><div class="empty-icon">üíâ</div><div>Sin registros hoy a√∫n</div></div>';
    return;
  }
  el.innerHTML = todayRecs.map((r,i) => buildPatientCard(r, i, false)).join('');
}

/* ===================================================
   TAB 2: PARTE DIARIO
   =================================================== */
function setFilter(f, btn) {
  currentFilter = f;
  if (btn) {
    document.querySelectorAll('#diario-filter-bar .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  renderDiario();
}

function renderDiario() {
  const search  = (document.getElementById('search-input').value||'').toLowerCase();
  const dateVal = document.getElementById('filter-date').value;
  let recs = filterRecords(currentFilter, dateVal);
  if (search) recs = recs.filter(r=>r.name.toLowerCase().includes(search));
  recs = recs.slice().reverse();

  const totalDoses = recs.reduce((a,r)=>a+r.vaccines.length,0);
  const byEsquema  = {};
  recs.forEach(r => { byEsquema[r.esquema] = (byEsquema[r.esquema]||0)+1; });
  const topEsquema = Object.entries(byEsquema).sort((a,b)=>b[1]-a[1])[0];

  document.getElementById('diario-stats').innerHTML = `
    <div class="stat-card"><div class="stat-num" style="color:var(--accent-color)">${recs.length}</div><div class="stat-label">Pacientes</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--green)">${totalDoses}</div><div class="stat-label">Dosis</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--orange)">${topEsquema?topEsquema[0].replace(' Meses','m').replace('Reci√©n Nacido','RN'):'‚Äî'}</div><div class="stat-label">Esquema top</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--purple)">${[...new Set(recs.flatMap(r=>r.vaccines.map(v=>v.id)))].length}</div><div class="stat-label">Biol√≥gicos</div></div>`;

  const list = document.getElementById('patient-list');
  const empty = document.getElementById('empty-diario');
  if (!recs.length) { list.innerHTML = ''; empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');
  list.innerHTML = recs.map((r,i) => buildPatientCard(r, i, true)).join('');
}

function buildPatientCard(r, i, showDelete) {
  const tags = r.vaccines.map(v => {
    const loteTag = v.lote ? `<span style="font-size:0.58rem;font-weight:700;color:var(--green);margin-left:3px;">¬∑ ${v.lote}</span>` : '';
    return `<span class="pc-tag" style="background:rgba(102,126,234,0.12);color:var(--accent-color)">${v.emoji} ${v.name}${loteTag}</span>`;
  }).join('');
  const del = showDelete ? `<button class="icon-btn" onclick="deleteRecord(${r.id})" title="Eliminar">üóëÔ∏è</button>` : '';
  return `
    <div class="patient-card ${r.color||stickyColor(i)}" style="animation:popIn 0.35s ease ${i*0.05}s both">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
        <div style="flex:1;min-width:0">
          <div class="pc-name">${r.name}</div>
          <div class="pc-meta">üìÖ ${fmtDate(r.dateApplied)} ¬∑ Esquema: ${r.esquema}</div>
          <div class="pc-tags">${tags}</div>
        </div>
        <div style="display:flex;gap:4px">${del}</div>
      </div>
    </div>`;
}

function deleteRecord(id) {
  if (!confirm('¬øEliminar este registro? El stock descontado no se revertir√° autom√°ticamente.')) return;
  records = records.filter(r=>r.id!==id);
  saveAll();
  renderDiario(); renderQuickStats(); renderQuickList(); renderBadgeDiario(); renderBadgePendientes();
  showToast('üóëÔ∏è Registro eliminado');
}

function renderBadgeDiario() {
  document.getElementById('badge-diario').textContent = records.filter(r=>r.dateApplied===todayStr()).length;
}

function renderBadgePendientes() {
  const today = new Date();
  const todayStr_ = todayStr();
  const byName = {};
  records.forEach(r => {
    if (!byName[r.name] || r.dateApplied > byName[r.name].dateApplied) byName[r.name] = r;
  });
  let count = 0;
  Object.values(byName).forEach(r => {
    const nextKey = NEXT_SCHEMA[r.esquemaKey];
    if (!nextKey) return;
    const dob = new Date(r.dob + 'T00:00:00');
    const estDate = new Date(dob);
    estDate.setMonth(estDate.getMonth() + parseInt(nextKey));
    if (estDate.toISOString().split('T')[0] <= todayStr_) count++;
  });
  const badge = document.getElementById('badge-pendientes');
  if (badge) badge.textContent = count;
}

/* ===================================================
   TAB 3: KARDEX
   =================================================== */
function renderKardex() {
  renderKdxSection('bio', 'inv-biologicos', BIO_NAMES);
  renderKdxSection('jer', 'inv-jeringas',   JER_NAMES);
}

function renderKdxSection(type, containerId, names) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';

  for (const [key, data] of Object.entries(inventory[type])) {
    const saldo = calcSaldo(data);
    let cls = saldo<=0 ? 'danger' : saldo<=5 ? 'warn' : '';

    // Check if any lot of this item is expiring soon
    const activeLots = getActiveLots(type, key);
    const hasExpiring = activeLots.some(l => isExpiringSoon(l.expiry));
    const hasExpired  = activeLots.some(l => isExpired(l.expiry));
    if (hasExpired && cls==='') cls = 'warn';

    const card = document.createElement('div');
    card.className = `kdx-card ${cls}`;
    card.onclick = () => openKdxDetail(key, type, names[key]);

    // Lotes mini display
    let lotsHtml = '';
    if (activeLots.length > 0) {
      lotsHtml = `<div class="kdx-lots">` +
        activeLots.map(l => {
          const expCls = isExpired(l.expiry) ? 'lot-expired' : isExpiringSoon(l.expiry) ? 'lot-expiring' : '';
          const expiryLabel = l.expiry ? fmtExpiry(l.expiry) : '';
          const warn = (isExpired(l.expiry) || isExpiringSoon(l.expiry)) ? '‚ö†Ô∏è' : '';
          return `<div class="kdx-lot-row">
            <span class="lot-num">${l.lote}</span>
            <span class="lot-exp ${expCls}">${l.qty}d ${warn}${expiryLabel}</span>
          </div>`;
        }).join('') +
      `</div>`;
    }

    card.innerHTML = `
      <div class="kdx-name">${names[key]}</div>
      <div class="kdx-saldo">${saldo}</div>
      <div class="kdx-mini">
        <span>I:${data.ing}</span>
        <span>A:${data.apl}</span>
        <span>P:${data.per}</span>
        <span>D:${data.dev}</span>
      </div>
      ${lotsHtml}`;
    container.appendChild(card);
  }
}

function openKdxDetail(key, type, name) {
  currentKdxKey  = key;
  currentKdxType = type;
  const data  = inventory[type][key];
  const saldo = calcSaldo(data);
  const activeLots = getActiveLots(type, key);

  let lotsDetailHtml = '';
  if (activeLots.length > 0) {
    lotsDetailHtml = `
      <div style="margin-top:14px;margin-bottom:4px;">
        <div style="font-size:0.72rem;font-weight:800;color:var(--empty-text);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">üì¶ Lotes activos</div>
        ${activeLots.map(l => {
          const expCls = isExpired(l.expiry) ? 'color:var(--red)' : isExpiringSoon(l.expiry) ? 'color:var(--orange)' : 'color:var(--green)';
          const warn   = isExpired(l.expiry) ? '‚õî Vencido' : isExpiringSoon(l.expiry) ? '‚ö†Ô∏è Por vencer' : '‚úÖ';
          const expLabel = l.expiry ? `¬∑ Vence ${fmtDate(l.expiry.substring(0,7)+'-01').substring(3)}` : '';
          return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--surface);border-radius:10px;margin-bottom:5px;font-size:0.82rem;">
            <div>
              <span style="font-weight:900;">${l.lote}</span>
              <span style="color:var(--empty-text);font-size:0.7rem;margin-left:6px;">${expLabel}</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="font-weight:800;${expCls}">${l.qty} dosis</span>
              <span style="font-size:0.65rem;">${warn}</span>
            </div>
          </div>`;
        }).join('')}
      </div>`;
  }

  document.getElementById('kdx-detail-title').textContent = name;
  document.getElementById('kdx-detail-body').innerHTML = `
    <div style="text-align:center;margin-bottom:18px;">
      <div style="font-family:'Indie Flower',cursive;font-size:3.5rem;color:${saldo<=0?'var(--red)':saldo<=5?'var(--orange)':'var(--green)'};">${saldo}</div>
      <div style="font-size:0.75rem;font-weight:800;color:var(--empty-text);text-transform:uppercase;letter-spacing:1px;">Saldo actual (dosis/unidades)</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
      <div style="background:rgba(5,150,105,0.08);border-radius:12px;padding:12px;text-align:center;">
        <div style="font-family:'Indie Flower',cursive;font-size:2rem;color:var(--green);">${data.ing}</div>
        <div style="font-size:0.65rem;font-weight:800;color:var(--empty-text);text-transform:uppercase;">üì• Ingresos</div>
      </div>
      <div style="background:rgba(124,58,237,0.08);border-radius:12px;padding:12px;text-align:center;">
        <div style="font-family:'Indie Flower',cursive;font-size:2rem;color:var(--purple);">${data.apl}</div>
        <div style="font-size:0.65rem;font-weight:800;color:var(--empty-text);text-transform:uppercase;">üíâ Aplicadas</div>
      </div>
      <div style="background:rgba(220,38,38,0.08);border-radius:12px;padding:12px;text-align:center;">
        <div style="font-family:'Indie Flower',cursive;font-size:2rem;color:var(--red);">${data.per}</div>
        <div style="font-size:0.65rem;font-weight:800;color:var(--empty-text);text-transform:uppercase;">‚ö†Ô∏è P√©rdidas</div>
      </div>
      <div style="background:rgba(37,99,235,0.08);border-radius:12px;padding:12px;text-align:center;">
        <div style="font-family:'Indie Flower',cursive;font-size:2rem;color:var(--blue);">${data.dev}</div>
        <div style="font-size:0.65rem;font-weight:800;color:var(--empty-text);text-transform:uppercase;">üì§ Devueltos</div>
      </div>
    </div>
    <div style="font-size:0.72rem;font-weight:700;color:var(--empty-text);text-align:center;">
      Saldo = Ingresos (${data.ing}) ‚àí Aplicadas (${data.apl}) ‚àí P√©rdidas (${data.per}) ‚àí Devueltos (${data.dev}) = <strong>${saldo}</strong>
    </div>
    ${lotsDetailHtml}`;

  // Bot√≥n movimiento: preselecciona este √≠tem
  document.getElementById('kdx-mov-btn').onclick = () => {
    closeModal('modal-kdx-detail');
    openMovModal(currentKdxType, currentKdxKey);
  };

  openModal('modal-kdx-detail');
}

/* ===================================================
   MODAL MOVIMIENTO
   =================================================== */
function openMovModal(type, preselect) {
  currentMovType = type;
  const isBio    = type === 'bio';
  const names    = isBio ? BIO_NAMES : JER_NAMES;
  const dict     = inventory[type];
  const select   = document.getElementById('mov-item');

  select.innerHTML = Object.entries(dict).map(([k]) =>
    `<option value="${k}">${names[k]}</option>`
  ).join('');

  // Preseleccionar el √≠tem correcto si viene de una tarjeta espec√≠fica
  if (preselect && select.querySelector(`option[value="${preselect}"]`)) {
    select.value = preselect;
  }

  // Label: "Biol√≥gico" si es bio, "Insumo" si es jer
  document.querySelector('#mov-bio-group .field-label').textContent = isBio ? 'üß™ Biol√≥gico' : 'üíâ Insumo';
  document.getElementById('modal-mov-title').textContent =
    isBio ? 'üß™ Registrar Movimiento ‚Äî Biol√≥gico' : 'üíâ Registrar Movimiento ‚Äî Insumo';

  document.getElementById('mov-fecha').value    = todayStr();
  document.getElementById('mov-fecha').max      = todayStr();
  document.getElementById('mov-cantidad').value = '';
  document.getElementById('mov-obs').value      = '';
  document.getElementById('mov-lote').value     = '';
  document.getElementById('mov-expiry').value   = '';
  document.getElementById('mov-tipo').value     = 'ingreso';
  toggleMovFields();
  openModal('modal-mov');
}

function onMovItemChange() {
  toggleMovFields(); // refresh lot selector when item changes
}

function toggleMovFields() {
  const tipo    = document.getElementById('mov-tipo').value;
  const item    = document.getElementById('mov-item').value;
  const isBio   = currentMovType === 'bio';

  document.getElementById('ingreso-fields').style.display = ((tipo==='ingreso'||tipo==='traspaso') && isBio) ? 'block' : 'none';
  document.getElementById('causa-group').style.display    = tipo==='perdida' ? 'block' : 'none';

  // Mostrar selector de lote para p√©rdida/devoluci√≥n si hay lotes disponibles
  const lotGroup = document.getElementById('lot-select-group');
  const lotSel   = document.getElementById('mov-lot-sel');
  if ((tipo==='perdida'||tipo==='devolucion') && isBio) {
    const activeLots = getActiveLots('bio', item);
    if (activeLots.length > 0) {
      lotSel.innerHTML = `<option value="">Sin especificar lote</option>` +
        activeLots.map(l => `<option value="${l.id}">${l.lote} ‚Äî ${l.qty} dosis${l.expiry?' ¬∑ vence '+fmtExpiry(l.expiry):''}</option>`).join('');
      lotGroup.style.display = 'block';
    } else {
      lotGroup.style.display = 'none';
    }
  } else {
    lotGroup.style.display = 'none';
  }
}

function saveMovimiento() {
  const fecha    = document.getElementById('mov-fecha').value;
  const item     = document.getElementById('mov-item').value;
  const tipo     = document.getElementById('mov-tipo').value;
  const cantidad = parseInt(document.getElementById('mov-cantidad').value)||0;
  const causa    = document.getElementById('mov-causa').value;
  const obs      = document.getElementById('mov-obs').value.trim();
  const loteNum  = document.getElementById('mov-lote').value.trim();
  const expiry   = document.getElementById('mov-expiry').value;
  const loteSel  = document.getElementById('mov-lot-sel').value;

  if (!fecha)         { showToast('‚ö†Ô∏è Selecciona la fecha'); return; }
  if (fecha>todayStr()){ showToast('‚ö†Ô∏è No se permiten fechas futuras'); return; }
  if (cantidad<=0)    { shakeInput('mov-cantidad'); showToast('‚ö†Ô∏è Ingresa una cantidad v√°lida'); return; }
  if (tipo==='perdida'&&!causa) { shakeInput('mov-causa'); showToast('‚ö†Ô∏è Debes indicar la causa de la p√©rdida'); return; }

  const names = currentMovType==='bio' ? BIO_NAMES : JER_NAMES;

  if (tipo!=='ingreso') {
    const saldo = calcSaldo(inventory[currentMovType][item]);
    if (cantidad>saldo) {
      if (!confirm(`‚ö†Ô∏è La cantidad (${cantidad}) supera el saldo actual (${saldo}). ¬øContinuar de todas formas?`)) return;
    }
  }

  // Actualizar inventario principal
  if (tipo==='ingreso'||tipo==='traspaso') inventory[currentMovType][item].ing += cantidad;
  if (tipo==='perdida')    inventory[currentMovType][item].per += cantidad;
  if (tipo==='devolucion') inventory[currentMovType][item].dev += cantidad;

  // Gesti√≥n de lotes
  let loteName = '';
  if ((tipo==='ingreso'||tipo==='traspaso') && currentMovType==='bio' && loteNum) {
    // Crear nuevo lote
    if (!lots.bio[item]) lots.bio[item] = [];
    const newLot = { id: Date.now(), lote: loteNum, expiry: expiry||'', qty: cantidad };
    lots.bio[item].push(newLot);
    loteName = loteNum;
  }
  if ((tipo==='perdida'||tipo==='devolucion') && currentMovType==='bio' && loteSel) {
    const lot = lots.bio[item] ? lots.bio[item].find(l=>l.id==loteSel) : null;
    if (lot) {
      lot.qty = Math.max(0, lot.qty - cantidad);
      loteName = lot.lote;
    }
  }

  movements.push({
    id: Date.now(), fecha, tipo,
    itemKey: item, itemName: names[item], itemType: currentMovType,
    cantidad,
    lote: loteName,
    expiry: (tipo==='ingreso' && expiry) ? expiry : '',
    causa: tipo==='perdida' ? causa : '',
    obs
  });

  saveAll();
  closeModal('modal-mov');
  renderKardex(); renderMovTable(); checkStockAlert();

  const tipoLabel = tipo==='ingreso'?'üì• Ingreso':tipo==='traspaso'?'üîÑ Traspaso':tipo==='perdida'?'‚ö†Ô∏è P√©rdida':'üì§ Devoluci√≥n';
  showToast(`${tipoLabel}: ${cantidad} √ó ${names[item]}${loteName?' ¬∑ Lote '+loteName:''}`);
}

/* ===================================================
   TABLA DE MOVIMIENTOS
   =================================================== */
function setMovFilter(f, btn) {
  currentMovFilter = f;
  if (btn) {
    document.querySelectorAll('#kardex-filter-bar .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  renderMovTable();
}

function renderMovTable() {
  const movs  = currentMovFilter==='todo' ? movements : filterMovements(currentMovFilter);
  const tbody = document.getElementById('mov-tbody');
  const empty = document.getElementById('empty-movs');

  if (!movs.length) { tbody.innerHTML=''; empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');
  tbody.innerHTML = movs.slice().reverse().map(m => {
    const tipoClass = m.tipo==='ingreso'?'mov-ingreso':m.tipo==='perdida'?'mov-perdida':m.tipo==='traspaso'?'mov-traspaso':'mov-devolucion';
    const tipoLabel = m.tipo==='ingreso'?'üì• Ingreso':m.tipo==='perdida'?'‚ö†Ô∏è P√©rdida':m.tipo==='traspaso'?'üîÑ Traspaso':'üì§ Devoluci√≥n';
    const sign      = (m.tipo==='ingreso'||m.tipo==='traspaso')?'+':'‚àí';
    const loteHtml  = m.lote ? `<span style="font-size:0.68rem;font-weight:800;background:rgba(102,126,234,0.1);color:var(--accent-color);padding:2px 7px;border-radius:8px;">${m.lote}</span>` : '‚Äî';
    return `<tr>
      <td style="white-space:nowrap">${fmtDate(m.fecha)}</td>
      <td style="font-weight:800">${m.itemName}</td>
      <td><span class="mov-type ${tipoClass}">${tipoLabel}</span></td>
      <td style="font-weight:900;color:${(m.tipo==='ingreso'||m.tipo==='traspaso')?'var(--green)':'var(--red)'}">${sign}${m.cantidad}</td>
      <td>${loteHtml}</td>
      <td style="font-size:0.75rem;color:var(--empty-text)">${m.causa||m.obs||'‚Äî'}</td>
      <td><button class="icon-btn" onclick="openEditMov(${m.id})" title="Editar">‚úèÔ∏è</button></td>
    </tr>`;
  }).join('');
}

/* ===================================================
   STOCK & EXPIRY ALERTS
   =================================================== */
function checkStockAlert() {
  // Stock cr√≠tico
  const critical = [];
  Object.entries(inventory.bio).forEach(([k,v]) => { if(calcSaldo(v)<=5) critical.push(BIO_NAMES[k]); });
  Object.entries(inventory.jer).forEach(([k,v]) => { if(calcSaldo(v)<=5) critical.push(JER_NAMES[k]); });

  const hStock = document.getElementById('stock-alert-header');
  const kStock = document.getElementById('stock-alert-kardex');
  if (critical.length) {
    hStock.style.display='block'; hStock.textContent=`‚ö†Ô∏è Stock bajo (‚â§5): ${critical.join(', ')}`;
    kStock.style.display='block'; kStock.textContent=`‚ö†Ô∏è Stock bajo (‚â§5): ${critical.join(' ¬∑ ')}`;
  } else {
    hStock.style.display='none'; kStock.style.display='none';
  }

  // Lotes pr√≥ximos a vencer
  const expiring = [];
  Object.entries(lots.bio).forEach(([k, lotArr]) => {
    if (!lotArr) return;
    lotArr.forEach(l => {
      if (l.qty>0 && (isExpired(l.expiry)||isExpiringSoon(l.expiry))) {
        expiring.push(`${BIO_NAMES[k]} (${l.lote})`);
      }
    });
  });

  const hExp = document.getElementById('expiry-alert-header');
  const kExp = document.getElementById('expiry-alert-kardex');
  if (expiring.length) {
    hExp.style.display='block'; hExp.textContent=`üïê Por vencer: ${expiring.join(', ')}`;
    kExp.style.display='block'; kExp.textContent=`üïê Lotes pr√≥ximos a vencer: ${expiring.join(' ¬∑ ')}`;
  } else {
    hExp.style.display='none'; kExp.style.display='none';
  }
}

/* ===================================================
   CIERRE DE MES
   =================================================== */
function closeMonth() {
  const month     = getMonthStr();
  const monthRecs = records.filter(r=>r.dateApplied.startsWith(month));

  if (!confirm(`‚ö†Ô∏è CIERRE DE MES\n\nEsto guardar√° el reporte de ${month} y reiniciar√° los contadores del Kardex.\n\nEl historial de ${monthRecs.length} pacientes se conserva.\n\n¬øContinuar?`)) return;

  localStorage.setItem(`vf2_snap_${month}`, JSON.stringify({
    month, inventory: JSON.parse(JSON.stringify(inventory)), records: monthRecs
  }));

  Object.keys(inventory.bio).forEach(k => inventory.bio[k] = mkEmpty());
  Object.keys(inventory.jer).forEach(k => inventory.jer[k] = mkEmpty());

  // Limpiar lotes con qty = 0 (los vencidos/agotados) y guardar snapshot de lotes tambi√©n
  Object.keys(lots.bio).forEach(k => {
    lots.bio[k] = lots.bio[k].filter(l => l.qty > 0);
  });

  saveAll(); renderKardex();
  showToast(`‚úÖ Mes ${month} cerrado. Kardex reiniciado.`);
}

/* ===================================================
   PENDIENTES ‚Äî MEJORADO
   =================================================== */
function renderPendientes() {
  const today = new Date();
  const todayStr_ = todayStr();
  const search = (document.getElementById('pend-search')?.value || '').toLowerCase();

  // √öltimo registro por paciente
  const byName = {};
  records.forEach(r => {
    if (!byName[r.name] || r.dateApplied > byName[r.name].dateApplied) byName[r.name] = r;
  });

  const pending = [];
  Object.values(byName).forEach(r => {
    const nextKey = NEXT_SCHEMA[r.esquemaKey];
    if (!nextKey) return;

    const dob = new Date(r.dob + 'T00:00:00');
    let months = (today.getFullYear() - dob.getFullYear()) * 12 + (today.getMonth() - dob.getMonth());
    if (today.getDate() < dob.getDate()) months--;
    months = Math.max(0, months);
    const nextAge = parseInt(nextKey);

    // Calcular fecha estimada del pr√≥ximo esquema desde nacimiento
    const dobDate = new Date(r.dob + 'T00:00:00');
    const estDate = new Date(dobDate);
    estDate.setMonth(estDate.getMonth() + nextAge);
    const estStr = estDate.toISOString().split('T')[0];

    // D√≠as de diferencia desde la fecha estimada
    const diffDays = Math.floor((today - estDate) / (1000 * 60 * 60 * 24));

    // Solo aparece si ya lleg√≥ la fecha estimada
    if (estStr > todayStr_) return;

    const nextVacs = MSP_DB[nextKey] ? MSP_DB[nextKey].map(v => v.name) : [];

    // Sem√°foro: rojo > 14 d√≠as, amarillo 1-14 d√≠as, verde = hoy
    let urgencia, urgColor, urgBg, urgIcon;
    if (diffDays <= 0) {
      urgencia = 'Hoy'; urgColor = '#059669'; urgBg = 'rgba(5,150,105,0.1)'; urgIcon = 'üü¢';
    } else if (diffDays <= 14) {
      urgencia = `${diffDays}d de retraso`; urgColor = '#d97706'; urgBg = 'rgba(217,119,6,0.1)'; urgIcon = 'üü°';
    } else {
      urgencia = `${diffDays}d de retraso`; urgColor = '#dc2626'; urgBg = 'rgba(220,38,38,0.1)'; urgIcon = 'üî¥';
    }

    pending.push({ ...r, nextKey, nextEsquema: nextKey === '0' ? 'Reci√©n Nacido' : nextKey + ' Meses',
      nextVacs, monthsOld: months, estStr, diffDays, urgencia, urgColor, urgBg, urgIcon });
  });

  // Ordenar: m√°s d√≠as de retraso primero
  pending.sort((a, b) => b.diffDays - a.diffDays);

  // Filtrar por b√∫squeda
  const filtered = search ? pending.filter(p => p.name.toLowerCase().includes(search)) : pending;

  const container = document.getElementById('pendientes-list');
  const empty     = document.getElementById('empty-pendientes');
  const counter   = document.getElementById('pend-counter');

  if (counter) counter.textContent = `${filtered.length} pendiente${filtered.length !== 1 ? 's' : ''}`;

  if (!filtered.length) {
    container.innerHTML = '';
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');

  container.innerHTML = filtered.map(p => `
    <div class="pending-card" style="border-left: 4px solid ${p.urgColor}; background: ${p.urgBg};">
      <div style="flex:1">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:3px;">
          <span style="font-size:1rem;">${p.urgIcon}</span>
          <div class="pending-name">${p.name}</div>
          <span style="font-size:0.68rem;font-weight:800;padding:2px 9px;border-radius:12px;background:${p.urgBg};color:${p.urgColor};border:1px solid ${p.urgColor}33;">${p.urgencia}</span>
        </div>
        <div class="pending-info">
          ${p.monthsOld} meses ¬∑ √öltimo: ${p.esquema} ¬∑ Fecha estimada: ${fmtDate(p.estStr)}
        </div>
        <div class="pending-chips" style="margin-top:5px;">
          <span style="font-size:0.65rem;font-weight:800;padding:2px 8px;border-radius:10px;background:rgba(102,126,234,0.12);color:var(--accent-color);">
            Pr√≥ximo: ${p.nextEsquema}
          </span>
          ${p.nextVacs.map(v => `<span class="pending-chip">${v}</span>`).join('')}
        </div>
      </div>
      <button class="btn btn-primary btn-sm" style="flex-shrink:0;" onclick="prefillPatient('${p.name.replace(/'/g, "\\'")}','${p.dob}','${p.nextKey}')">
        Vacunar ‚Üí
      </button>
    </div>`).join('');
}

// BUG FIXED: ahora recibe nextKey (el valor real "2","4", etc.) directamente
function prefillPatient(name, dob, nextKey) {
  // Activar correctamente el tab Vacunar ‚Äî busca por texto exacto
  const vacTab = [...document.querySelectorAll('.tab-btn')].find(b => b.textContent.includes('Vacunar'));
  switchTab('vacunar', vacTab);
  setTimeout(() => {
    document.getElementById('p-name').value   = name;
    document.getElementById('p-dob').value    = dob;
    document.getElementById('p-esquema').value = nextKey;
    const label = nextKey==='0'?'Reci√©n Nacido':nextKey+' Meses';
    const badge = document.getElementById('age-badge');
    badge.textContent = `üìã Cargado desde Pendientes ‚Äî Esquema ${label}`;
    badge.style.display = 'block';
    renderVaccines();
    showToast(`üìã ${name} cargado ‚Äî Esquema ${label}`);
  }, 150);
}

/* ===================================================
   REPORTES
   =================================================== */
function renderReportStats() {
  const month     = getMonthStr();
  const monthRecs = records.filter(r=>r.dateApplied.startsWith(month));
  const totalDoses = monthRecs.reduce((a,r)=>a+r.vaccines.length,0);
  const totalLoss  = Object.values(inventory.bio).reduce((a,v)=>a+v.per,0);
  const totalIng   = Object.values(inventory.bio).reduce((a,v)=>a+v.ing,0);
  const totalDev   = Object.values(inventory.bio).reduce((a,v)=>a+v.dev,0);

  document.getElementById('report-stats').innerHTML = `
    <div class="stat-card"><div class="stat-num" style="color:var(--accent-color)">${monthRecs.length}</div><div class="stat-label">Ni√±os vacunados</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--green)">${totalDoses}</div><div class="stat-label">Dosis aplicadas</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--blue)">${totalIng}</div><div class="stat-label">Biol√≥gicos recibidos</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--orange)">${totalDev}</div><div class="stat-label">Devuelto al Distrito</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--red)">${totalLoss}</div><div class="stat-label">P√©rdidas</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--purple)">${movements.filter(m=>m.fecha.startsWith(month)).length}</div><div class="stat-label">Movimientos</div></div>`;
}

function renderStorageInfo() {
  try {
    const used = Object.keys(localStorage).filter(k=>k.startsWith('vf2_')).reduce((a,k)=>a+localStorage.getItem(k).length,0);
    document.getElementById('storage-info').innerHTML = `
      üì¶ ${records.length} pacientes registrados<br>
      üì¶ ${movements.length} movimientos de inventario<br>
      üíæ ~${(used/1024).toFixed(1)} KB usados localmente`;
  } catch(e) {}
}

/* ===================================================
   EXCEL EXPORTS
   =================================================== */
function makeWB() { return XLSX.utils.book_new(); }
function makeWS(data, cols) {
  const ws = XLSX.utils.json_to_sheet(data);
  if (cols) ws['!cols'] = cols;
  return ws;
}
function dl(wb, name) {
  XLSX.writeFile(wb, name);
  try { confetti({ particleCount:140, spread:75, origin:{y:0.6}, colors:['#667eea','#764ba2','#10b981','#f59e0b'] }); } catch(e){}
  showToast(`üì• ${name} descargado`);
}

function exportPatients() {
  const month = getMonthStr();
  const recs  = records.filter(r=>r.dateApplied.startsWith(month));
  if (!recs.length) { showToast('‚ö†Ô∏è Sin registros este mes'); return; }
  const data = recs.map(r => ({
    'FECHA APLICACI√ìN': r.dateApplied,
    'FECHA (FORMATO)':  fmtDate(r.dateApplied),
    'APELLIDOS Y NOMBRES': r.name,
    'FECHA NACIMIENTO': r.dob,
    'ESQUEMA': r.esquema,
    'VACUNAS ADMINISTRADAS': r.vaccines.map(v=>v.name).join(' + '),
    'N¬∞ DOSIS': r.vaccines.length,
    'V√çAS': r.vaccines.map(v=>v.desc).join(' / ')
  }));
  const wb = makeWB();
  XLSX.utils.book_append_sheet(wb, makeWS(data,[{wch:15},{wch:16},{wch:32},{wch:15},{wch:14},{wch:50},{wch:8},{wch:30}]), 'Pacientes');
  dl(wb, `VacuFlow_Pacientes_${month}.xlsx`);
}

function exportKardex() {
  const month = getMonthStr();
  const data  = Object.entries(inventory.bio).map(([k,v]) => ({
    'BIOL√ìGICO': BIO_NAMES[k], 'INGRESOS': v.ing, 'APLICADAS': v.apl,
    'P√âRDIDAS': v.per, 'DEVOLUCIONES': v.dev, 'SALDO ACTUAL': calcSaldo(v)
  }));
  const wb = makeWB();
  XLSX.utils.book_append_sheet(wb, makeWS(data,[{wch:24},{wch:10},{wch:10},{wch:10},{wch:14},{wch:14}]), 'Kardex Biol√≥gicos');
  dl(wb, `VacuFlow_Kardex_${month}.xlsx`);
}

function exportJeringas() {
  const month = getMonthStr();
  const data  = Object.entries(inventory.jer).map(([k,v]) => ({
    'JERINGA': JER_NAMES[k], 'INGRESOS': v.ing, 'USADAS': v.apl,
    'P√âRDIDAS': v.per, 'DEVOLUCIONES': v.dev, 'SALDO ACTUAL': calcSaldo(v)
  }));
  const wb = makeWB();
  XLSX.utils.book_append_sheet(wb, makeWS(data,[{wch:22},{wch:10},{wch:8},{wch:10},{wch:14},{wch:14}]), 'Jeringas');
  dl(wb, `VacuFlow_Jeringas_${month}.xlsx`);
}

function exportMovimientos() {
  if (!movements.length) { showToast('‚ö†Ô∏è Sin movimientos registrados'); return; }
  const data = movements.slice().reverse().map(m => ({
    'FECHA': m.fecha, 'FECHA (FORMATO)': fmtDate(m.fecha),
    'BIOL√ìGICO/INSUMO': m.itemName,
    'TIPO': m.tipo==='ingreso'?'Ingreso':m.tipo==='traspaso'?'Traspaso':m.tipo==='perdida'?'P√©rdida/Descarte':'Devoluci√≥n',
    'CANTIDAD': (m.tipo==='ingreso'||m.tipo==='traspaso')?m.cantidad:-m.cantidad,
    'LOTE': m.lote||'',
    'VENCIMIENTO': m.expiry?fmtDate(m.expiry.substring(0,7)+'-01').substring(3):'',
    'CAUSA': m.causa||'', 'OBSERVACIONES': m.obs||''
  }));
  const wb = makeWB();
  XLSX.utils.book_append_sheet(wb, makeWS(data,[{wch:12},{wch:16},{wch:24},{wch:18},{wch:10},{wch:12},{wch:14},{wch:28},{wch:30}]), 'Movimientos');
  dl(wb, `VacuFlow_Movimientos.xlsx`);
}

function buildPersonalSheet() {
  // Una fila por cada vacuna aplicada a cada ni√±o
  const rows = [];
  [...records].sort((a,b)=>a.dateApplied.localeCompare(b.dateApplied)).forEach(r => {
    const age = r.ageMonths !== undefined ? `${r.ageMonths} mes${r.ageMonths===1?'':'es'}` : '';
    r.vaccines.forEach(v => {
      rows.push({
        'FECHA APLICACI√ìN': r.dateApplied,
        'FECHA (LEGIBLE)':  fmtDate(r.dateApplied),
        'NOMBRE DEL NI√ëO':  r.name,
        'FECHA NACIMIENTO': r.dob,
        'EDAD AL VACUNAR':  age,
        'ESQUEMA':          r.esquema,
        'VACUNA APLICADA':  v.name,
        'V√çA':              v.desc,
        'LOTE APLICADO':    v.lote||'Sin especificar'
      });
    });
  });
  return makeWS(rows, [{wch:16},{wch:16},{wch:30},{wch:15},{wch:14},{wch:14},{wch:22},{wch:16},{wch:14}]);
}

function exportCompleto() {
  const month     = getMonthStr();
  const monthRecs = records.filter(r=>r.dateApplied.startsWith(month));
  const wb = makeWB();

  // Hoja 1: Pacientes del mes
  if (monthRecs.length) {
    const d = monthRecs.map(r => ({
      'FECHA': r.dateApplied, 'PACIENTE': r.name, 'F. NAC.': r.dob,
      'ESQUEMA': r.esquema, 'VACUNAS': r.vaccines.map(v=>v.name).join(' + '), 'N¬∞ DOSIS': r.vaccines.length
    }));
    XLSX.utils.book_append_sheet(wb, makeWS(d,[{wch:12},{wch:30},{wch:14},{wch:14},{wch:46},{wch:8}]), '1. Pacientes');
  }

  // Hoja 2: Biol√≥gicos
  const dBio = Object.entries(inventory.bio).map(([k,v]) => ({
    'BIOL√ìGICO': BIO_NAMES[k], 'INGRESOS': v.ing, 'APLICADAS': v.apl,
    'P√âRDIDAS': v.per, 'DEVUELTOS': v.dev, 'SALDO': calcSaldo(v)
  }));
  XLSX.utils.book_append_sheet(wb, makeWS(dBio,[{wch:22},{wch:10},{wch:10},{wch:10},{wch:10},{wch:10}]), '2. Biol√≥gicos');

  // Hoja 3: Jeringas
  const dJer = Object.entries(inventory.jer).map(([k,v]) => ({
    'JERINGA': JER_NAMES[k], 'INGRESOS': v.ing, 'USADAS': v.apl,
    'P√âRDIDAS': v.per, 'DEVUELTAS': v.dev, 'SALDO': calcSaldo(v)
  }));
  XLSX.utils.book_append_sheet(wb, makeWS(dJer,[{wch:22},{wch:10},{wch:10},{wch:10},{wch:10},{wch:10}]), '3. Jeringas');

  // Hoja 4: Movimientos
  if (movements.length) {
    const dMov = movements.slice().reverse().map(m => ({
      'FECHA': m.fecha, 'BIOL√ìGICO/INSUMO': m.itemName,
      'TIPO': m.tipo==='ingreso'?'Ingreso':m.tipo==='perdida'?'P√©rdida':'Devoluci√≥n',
      'CANTIDAD': m.tipo==='ingreso'?m.cantidad:-m.cantidad,
      'LOTE': m.lote||'', 'CAUSA': m.causa||'', 'OBS': m.obs||''
    }));
    XLSX.utils.book_append_sheet(wb, makeWS(dMov,[{wch:12},{wch:22},{wch:12},{wch:10},{wch:12},{wch:28},{wch:28}]), '4. Movimientos');
  }

  // Hoja 5: Resumen MSP
  const totalDoses = monthRecs.reduce((a,r)=>a+r.vaccines.length,0);
  const dRes = [
    {'INDICADOR':'Mes','VALOR':month},
    {'INDICADOR':'Ni√±os vacunados','VALOR':monthRecs.length},
    {'INDICADOR':'Total dosis aplicadas','VALOR':totalDoses},
    {'INDICADOR':'Biol√≥gicos recibidos del Distrito','VALOR':Object.values(inventory.bio).reduce((a,v)=>a+v.ing,0)},
    {'INDICADOR':'Biol√≥gicos devueltos al Distrito','VALOR':Object.values(inventory.bio).reduce((a,v)=>a+v.dev,0)},
    {'INDICADOR':'P√©rdidas de biol√≥gicos','VALOR':Object.values(inventory.bio).reduce((a,v)=>a+v.per,0)},
    {'INDICADOR':'Jeringas 23G usadas','VALOR':inventory.jer['23G'].apl},
    {'INDICADOR':'Jeringas 25G usadas','VALOR':inventory.jer['25G'].apl},
    {'INDICADOR':'Jeringas 27G usadas','VALOR':inventory.jer['27G'].apl},
  ];
  XLSX.utils.book_append_sheet(wb, makeWS(dRes,[{wch:36},{wch:14}]), '5. Resumen MSP');

  // Hoja 6: Registro Personal ‚Äî una fila por vacuna por ni√±o
  XLSX.utils.book_append_sheet(wb, buildPersonalSheet(), '6. Registro Personal');

  dl(wb, `VacuFlow_ReporteMSP_${month}.xlsx`);
}

/* ===================================================
   EDITAR MOVIMIENTO
   =================================================== */
let editingMovId = null;

function openEditMov(id) {
  const m = movements.find(x => x.id === id);
  if (!m) return;
  editingMovId = id;

  document.getElementById('edit-fecha').value    = m.fecha;
  document.getElementById('edit-tipo').value     = m.tipo;
  document.getElementById('edit-cantidad').value = m.cantidad;
  document.getElementById('edit-lote').value     = m.lote || '';
  document.getElementById('edit-causa').value    = m.causa || '';
  document.getElementById('edit-obs').value      = m.obs || '';
  toggleEditCausa();
  openModal('modal-edit-mov');
}

function toggleEditCausa() {
  const tipo = document.getElementById('edit-tipo').value;
  document.getElementById('edit-causa-group').style.display = tipo === 'perdida' ? 'block' : 'none';
}

function saveEditMovimiento() {
  const m = movements.find(x => x.id === editingMovId);
  if (!m) return;

  const oldTipo     = m.tipo;
  const oldCantidad = m.cantidad;
  const oldItem     = m.itemKey;
  const oldType     = m.itemType;

  const newFecha    = document.getElementById('edit-fecha').value;
  const newTipo     = document.getElementById('edit-tipo').value;
  const newCantidad = parseInt(document.getElementById('edit-cantidad').value) || 0;
  const newLote     = document.getElementById('edit-lote').value.trim().toUpperCase();
  const newCausa    = document.getElementById('edit-causa').value;
  const newObs      = document.getElementById('edit-obs').value.trim();

  if (!newFecha)       { showToast('‚ö†Ô∏è Selecciona la fecha'); return; }
  if (newCantidad <= 0){ shakeInput('edit-cantidad'); showToast('‚ö†Ô∏è Cantidad inv√°lida'); return; }
  if (newTipo === 'perdida' && !newCausa) { shakeInput('edit-causa'); showToast('‚ö†Ô∏è Indica la causa de la p√©rdida'); return; }

  // Calcular saldo simulado: revertir el old, aplicar el new, verificar que no quede negativo
  let simIng = inventory[oldType][oldItem].ing;
  let simPer = inventory[oldType][oldItem].per;
  let simDev = inventory[oldType][oldItem].dev;
  if (oldTipo==='ingreso'||oldTipo==='traspaso') simIng -= oldCantidad;
  if (oldTipo==='perdida')    simPer -= oldCantidad;
  if (oldTipo==='devolucion') simDev -= oldCantidad;
  if (newTipo==='ingreso'||newTipo==='traspaso') simIng += newCantidad;
  if (newTipo==='perdida')    simPer += newCantidad;
  if (newTipo==='devolucion') simDev += newCantidad;
  const simSaldo = simIng - inventory[oldType][oldItem].apl - simPer - simDev;
  if (simSaldo < 0) {
    if (!confirm(`‚ö†Ô∏è Esta edici√≥n dejar√≠a el saldo en ${simSaldo}.\n¬øContinuar de todas formas?`)) return;
  }

  // Revertir efecto del movimiento anterior en el inventario
  if (oldTipo==='ingreso'||oldTipo==='traspaso') inventory[oldType][oldItem].ing -= oldCantidad;
  if (oldTipo==='perdida')    inventory[oldType][oldItem].per -= oldCantidad;
  if (oldTipo==='devolucion') inventory[oldType][oldItem].dev -= oldCantidad;

  // Si hab√≠a lote vinculado, devolver cantidad al lote
  if (m.lote && oldType==='bio' && lots.bio[oldItem]) {
    // Buscar por nombre de lote ya que el id puede diferir
    const lot = lots.bio[oldItem].find(l => l.lote === m.lote);
    if (lot) {
      if (oldTipo==='ingreso'||oldTipo==='traspaso') lot.qty -= oldCantidad;
      else lot.qty += oldCantidad;
    }
  }

  // Aplicar nuevo efecto
  if (newTipo==='ingreso'||newTipo==='traspaso') inventory[oldType][oldItem].ing += newCantidad;
  if (newTipo==='perdida')    inventory[oldType][oldItem].per += newCantidad;
  if (newTipo==='devolucion') inventory[oldType][oldItem].dev += newCantidad;

  // Ajustar lote si aplica
  if (newLote && oldType==='bio' && lots.bio[oldItem]) {
    const lot = lots.bio[oldItem].find(l => l.lote === newLote);
    if (lot) {
      if (newTipo==='ingreso'||newTipo==='traspaso') {
        lot.qty += newCantidad;
      } else {
        if (lot.qty - newCantidad < 0) {
          if (!confirm(`‚ö†Ô∏è El lote ${newLote} solo tiene ${lot.qty} dosis. La edici√≥n lo dejar√≠a en ${lot.qty - newCantidad}. ¬øContinuar?`)) return;
        }
        lot.qty = Math.max(0, lot.qty - newCantidad);
      }
    }
  }

  // Actualizar movimiento
  m.fecha    = newFecha;
  m.tipo     = newTipo;
  m.cantidad = newCantidad;
  m.lote     = newLote;
  m.causa    = newTipo==='perdida' ? newCausa : '';
  m.obs      = newObs;

  saveAll();
  closeModal('modal-edit-mov');
  renderKardex(); renderMovTable(); checkStockAlert();
  showToast('‚úÖ Movimiento actualizado');
}

/* ===================================================
   MODAL HELPERS
   =================================================== */
function openModal(id)  { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('show');
  });
});

/* ===================================================
   UTILS
   =================================================== */
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => toast.classList.remove('show'), 3200);
}

function shakeInput(id) {
  const el = document.getElementById(id);
  el.classList.remove('shake'); void el.offsetWidth;
  el.classList.add('shake');
  el.addEventListener('animationend', () => el.classList.remove('shake'), { once:true });
  el.focus();
}

function clearAllData() {
  if (!confirm('‚ö†Ô∏è ATENCI√ìN\n\nEsto eliminar√° TODOS los datos: pacientes, inventario, lotes e historial.\n\nEsta acci√≥n NO se puede deshacer.\n\n¬øEst√°s seguro?')) return;
  Object.keys(localStorage).filter(k=>k.startsWith('vf2_')).forEach(k=>localStorage.removeItem(k));
  showToast('üóëÔ∏è Todos los datos han sido eliminados');
  setTimeout(() => location.reload(), 1500);
}

/* ===================================================
   START
   =================================================== */
window.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
